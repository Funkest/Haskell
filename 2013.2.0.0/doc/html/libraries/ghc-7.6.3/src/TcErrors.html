<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>typecheck\TcErrors.lhs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
\begin{code}
<pre><a name="line-1"></a><span class='hs-comment'>{-# LANGUAGE ScopedTypeVariables #-}</span>
<a name="line-2"></a><span class='hs-comment'>{-# OPTIONS -fno-warn-tabs #-}</span>
<a name="line-3"></a><span class='hs-comment'>-- The above warning supression flag is a temporary kludge.</span>
<a name="line-4"></a><span class='hs-comment'>-- While working on this module you are encouraged to remove it and</span>
<a name="line-5"></a><span class='hs-comment'>-- detab the module (please do the detabbing in a separate patch). See</span>
<a name="line-6"></a><span class='hs-comment'>--     <a href="http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces">http://hackage.haskell.org/trac/ghc/wiki/Commentary/CodingStyle#TabsvsSpaces</a></span>
<a name="line-7"></a><span class='hs-comment'>-- for details</span>
<a name="line-8"></a>
<a name="line-9"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>TcErrors</span><span class='hs-layout'>(</span> 
<a name="line-10"></a>       <span class='hs-varid'>reportUnsolved</span><span class='hs-layout'>,</span> <span class='hs-conid'>ErrEnv</span><span class='hs-layout'>,</span>
<a name="line-11"></a>       <span class='hs-varid'>warnDefaulting</span><span class='hs-layout'>,</span>
<a name="line-12"></a>
<a name="line-13"></a>       <span class='hs-varid'>flattenForAllErrorTcS</span><span class='hs-layout'>,</span>
<a name="line-14"></a>       <span class='hs-varid'>solverDepthErrorTcS</span>
<a name="line-15"></a>  <span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-16"></a>
<a name="line-17"></a><span class='hs-cpp'>#include "HsVersions.h"</span>
<a name="line-18"></a>
<a name="line-19"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcCanonical</span><span class='hs-layout'>(</span> <span class='hs-varid'>occurCheckExpand</span> <span class='hs-layout'>)</span>
<a name="line-20"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcRnMonad</span>
<a name="line-21"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcMType</span>
<a name="line-22"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcType</span>
<a name="line-23"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TypeRep</span>
<a name="line-24"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Type</span>
<a name="line-25"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Kind</span> <span class='hs-layout'>(</span> <span class='hs-varid'>isKind</span> <span class='hs-layout'>)</span>
<a name="line-26"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Unify</span>            <span class='hs-layout'>(</span> <span class='hs-varid'>tcMatchTys</span> <span class='hs-layout'>)</span>
<a name="line-27"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Inst</span>
<a name="line-28"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>InstEnv</span>
<a name="line-29"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TyCon</span>
<a name="line-30"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>TcEvidence</span>
<a name="line-31"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Name</span>
<a name="line-32"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>NameEnv</span>
<a name="line-33"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Id</span>               <span class='hs-layout'>(</span> <span class='hs-varid'>idType</span> <span class='hs-layout'>)</span>
<a name="line-34"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Var</span>
<a name="line-35"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarSet</span>
<a name="line-36"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>VarEnv</span>
<a name="line-37"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Bag</span>
<a name="line-38"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Maybes</span>
<a name="line-39"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>ErrUtils</span>         <span class='hs-layout'>(</span> <span class='hs-conid'>ErrMsg</span><span class='hs-layout'>,</span> <span class='hs-varid'>makeIntoWarning</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprLocErrMsg</span> <span class='hs-layout'>)</span>
<a name="line-40"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>SrcLoc</span>           <span class='hs-layout'>(</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-layout'>)</span>
<a name="line-41"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Util</span>
<a name="line-42"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>FastString</span>
<a name="line-43"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Outputable</span>
<a name="line-44"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>DynFlags</span>
<a name="line-45"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>        <span class='hs-layout'>(</span> <span class='hs-varid'>partition</span><span class='hs-layout'>,</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-layout'>)</span>
</pre>\end{code}

%************************************************************************
%*									*
\section{Errors and contexts}
%*									*
%************************************************************************

ToDo: for these error messages, should we note the location as coming
from the insts, or just whatever seems to be around in the monad just
now?

\begin{code}
<pre><a name="line-1"></a><a name="ErrEnv"></a><span class='hs-comment'>-- We keep an environment mapping coercion ids to the error messages they</span>
<a name="line-2"></a><a name="ErrEnv"></a><span class='hs-comment'>-- trigger; this is handy for -fwarn--type-errors</span>
<a name="line-3"></a><a name="ErrEnv"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>ErrEnv</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>VarEnv</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ErrMsg</span><span class='hs-keyglyph'>]</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="reportUnsolved"></a><span class='hs-definition'>reportUnsolved</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>Bag</span> <span class='hs-conid'>EvBind</span><span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-definition'>reportUnsolved</span> <span class='hs-varid'>runtimeCoercionErrors</span> <span class='hs-varid'>wanted</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyWC</span> <span class='hs-varid'>wanted</span>
<a name="line-8"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>emptyBag</span>
<a name="line-9"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span>   <span class='hs-comment'>-- Zonk to un-flatten any flatten-skols</span>
<a name="line-11"></a>         <span class='hs-varid'>wanted</span>  <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkWC</span> <span class='hs-varid'>wanted</span>
<a name="line-12"></a>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>env0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInitTidyEnv</span>
<a name="line-14"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>defer</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>runtimeCoercionErrors</span> 
<a name="line-15"></a>                  <span class='hs-keyword'>then</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newTcEvBinds</span>
<a name="line-16"></a>                          <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>Just</span> <span class='hs-varid'>ev</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-17"></a>                  <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-conid'>Nothing</span>
<a name="line-18"></a>
<a name="line-19"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>errs_so_far</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ifErrsM</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-conid'>True</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>return</span> <span class='hs-conid'>False</span><span class='hs-layout'>)</span>
<a name="line-20"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>tidy_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyFreeTyVars</span> <span class='hs-varid'>env0</span> <span class='hs-varid'>free_tvs</span>
<a name="line-21"></a>             <span class='hs-varid'>free_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarsOfWC</span> <span class='hs-varid'>wanted</span>
<a name="line-22"></a>             <span class='hs-varid'>err_ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CEC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_encl</span>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-23"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cec_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>errs_so_far</span> <span class='hs-varop'>||</span> <span class='hs-varid'>insolubleWC</span> <span class='hs-varid'>wanted</span>
<a name="line-24"></a>                                          <span class='hs-comment'>-- Don't report ambiguity errors if</span>
<a name="line-25"></a>                                          <span class='hs-comment'>-- there are any other solid errors </span>
<a name="line-26"></a>                                          <span class='hs-comment'>-- to report</span>
<a name="line-27"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cec_extra</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-28"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cec_tidy</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidy_env</span>
<a name="line-29"></a>                            <span class='hs-layout'>,</span> <span class='hs-varid'>cec_defer</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>defer</span> <span class='hs-layout'>}</span>
<a name="line-30"></a>
<a name="line-31"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"reportUnsolved:"</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>pprTvBndrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-varid'>free_tvs</span><span class='hs-layout'>)</span>
<a name="line-32"></a>                                         <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>wanted</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-33"></a>
<a name="line-34"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>reportWanteds</span> <span class='hs-varid'>err_ctxt</span> <span class='hs-varid'>wanted</span>
<a name="line-35"></a>
<a name="line-36"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>defer</span> <span class='hs-keyword'>of</span>
<a name="line-37"></a>           <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varid'>emptyBag</span>
<a name="line-38"></a>           <span class='hs-conid'>Just</span> <span class='hs-varid'>ev</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>getTcEvBinds</span> <span class='hs-varid'>ev</span> <span class='hs-layout'>}</span>
<a name="line-39"></a>
<a name="line-40"></a><span class='hs-comment'>--------------------------------------------</span>
<a name="line-41"></a><span class='hs-comment'>--      Internal functions</span>
<a name="line-42"></a><span class='hs-comment'>--------------------------------------------</span>
<a name="line-43"></a>
<a name="line-44"></a><a name="ReportErrCtxt"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>ReportErrCtxt</span> 
<a name="line-45"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-conid'>CEC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_encl</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Implication</span><span class='hs-keyglyph'>]</span>  <span class='hs-comment'>-- Enclosing implications</span>
<a name="line-46"></a>                	       	       <span class='hs-comment'>--   (innermost first)</span>
<a name="line-47"></a>                                       <span class='hs-comment'>-- ic_skols and givens are tidied, rest are not</span>
<a name="line-48"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>cec_tidy</span>  <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span>
<a name="line-49"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>cec_extra</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span>       <span class='hs-comment'>-- Add this to each error message</span>
<a name="line-50"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>cec_insol</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span>       <span class='hs-comment'>-- True &lt;=&gt; do not report errors involving </span>
<a name="line-51"></a>                                    <span class='hs-comment'>--          ambiguous errors</span>
<a name="line-52"></a>          <span class='hs-layout'>,</span> <span class='hs-varid'>cec_defer</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>EvBindsVar</span> 
<a name="line-53"></a>                         <span class='hs-comment'>-- Nothinng &lt;=&gt; errors are, well, errors</span>
<a name="line-54"></a>                         <span class='hs-comment'>-- Just ev  &lt;=&gt; make errors into warnings, and emit evidence</span>
<a name="line-55"></a>                         <span class='hs-comment'>--              bindings into 'ev' for unsolved constraints</span>
<a name="line-56"></a>      <span class='hs-layout'>}</span>
<a name="line-57"></a>
<a name="line-58"></a><a name="reportImplic"></a><span class='hs-definition'>reportImplic</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-59"></a><span class='hs-definition'>reportImplic</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>implic</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>given</span>
<a name="line-60"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ic_wanted</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>wanted</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_binds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>evb</span>
<a name="line-61"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>ic_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insoluble</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-62"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>BracketSkol</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>loc</span>
<a name="line-63"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-varid'>insoluble</span> <span class='hs-comment'>-- For Template Haskell brackets report only</span>
<a name="line-64"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>     <span class='hs-comment'>-- definite errors. The whole thing will be re-checked</span>
<a name="line-65"></a>                  <span class='hs-comment'>-- later when we plug it in, and meanwhile there may</span>
<a name="line-66"></a>                  <span class='hs-comment'>-- certainly be un-satisfied constraints</span>
<a name="line-67"></a>
<a name="line-68"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-69"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reportWanteds</span> <span class='hs-varid'>ctxt'</span> <span class='hs-varid'>wanted</span>
<a name="line-70"></a>  <span class='hs-keyword'>where</span>
<a name="line-71"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tvs'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapAccumL</span> <span class='hs-varid'>tidyTyVarBndr</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_tidy</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>tvs</span>
<a name="line-72"></a>    <span class='hs-varid'>implic'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implic</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ic_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs'</span>
<a name="line-73"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>ic_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyEvVar</span> <span class='hs-varid'>env1</span><span class='hs-layout'>)</span> <span class='hs-varid'>given</span>
<a name="line-74"></a>                     <span class='hs-layout'>,</span> <span class='hs-varid'>ic_loc</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyGivenLoc</span> <span class='hs-varid'>env1</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span>
<a name="line-75"></a>    <span class='hs-varid'>ctxt'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_tidy</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env1</span>
<a name="line-76"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>cec_encl</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implic'</span> <span class='hs-conop'>:</span> <span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span>
<a name="line-77"></a>                 <span class='hs-layout'>,</span> <span class='hs-varid'>cec_defer</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cec_defer</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span>
<a name="line-78"></a>                                 <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-79"></a>                                 <span class='hs-conid'>Just</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>evb</span> <span class='hs-layout'>}</span>
<a name="line-80"></a>
<a name="line-81"></a><a name="reportWanteds"></a><span class='hs-definition'>reportWanteds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>WantedConstraints</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-82"></a><span class='hs-definition'>reportWanteds</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>WC</span> <span class='hs-layout'>{</span> <span class='hs-varid'>wc_flat</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>flats</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_insol</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>insols</span><span class='hs-layout'>,</span> <span class='hs-varid'>wc_impl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>implics</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-83"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reportTidyWanteds</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tidy_insols</span> <span class='hs-varid'>tidy_flats</span> <span class='hs-varid'>implics</span>
<a name="line-84"></a>  <span class='hs-keyword'>where</span>
<a name="line-85"></a>    <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cec_tidy</span> <span class='hs-varid'>ctxt</span>
<a name="line-86"></a>    <span class='hs-varid'>tidy_insols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCt</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>insols</span>
<a name="line-87"></a>    <span class='hs-varid'>tidy_flats</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCt</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>keepWanted</span> <span class='hs-varid'>flats</span><span class='hs-layout'>)</span>
<a name="line-88"></a>                  <span class='hs-comment'>-- See Note [Do not report derived but soluble errors]</span>
<a name="line-89"></a>
<a name="line-90"></a><a name="reportTidyWanteds"></a><span class='hs-definition'>reportTidyWanteds</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bag</span> <span class='hs-conid'>Implication</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-91"></a><span class='hs-definition'>reportTidyWanteds</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>insols</span> <span class='hs-varid'>flats</span> <span class='hs-varid'>implics</span>
<a name="line-92"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cec_defer</span> <span class='hs-varid'>ctxt</span>
<a name="line-93"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-comment'>-- Defer errors to runtime</span>
<a name="line-94"></a>         <span class='hs-comment'>-- See Note [Deferring coercion errors to runtime] in TcSimplify</span>
<a name="line-95"></a>         <span class='hs-varid'>mapBagM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>deferToRuntime</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>mkFlatErr</span><span class='hs-layout'>)</span> 
<a name="line-96"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>flats</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>insols</span><span class='hs-layout'>)</span>
<a name="line-97"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapBagM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>reportImplic</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>implics</span> <span class='hs-layout'>}</span>
<a name="line-98"></a>
<a name="line-99"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-100"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>reportInsolsAndFlats</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>insols</span> <span class='hs-varid'>flats</span>
<a name="line-101"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mapBagM_</span> <span class='hs-layout'>(</span><span class='hs-varid'>reportImplic</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>implics</span> <span class='hs-layout'>}</span>
<a name="line-102"></a>             
<a name="line-103"></a>
<a name="line-104"></a><a name="deferToRuntime"></a><span class='hs-definition'>deferToRuntime</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>EvBindsVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span><span class='hs-layout'>)</span> 
<a name="line-105"></a>               <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-106"></a><span class='hs-definition'>deferToRuntime</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>mk_err_msg</span> <span class='hs-varid'>ct</span> 
<a name="line-107"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Wanted</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_wloc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_pred</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>ctev_evar</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ev_id</span> <span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cc_ev</span> <span class='hs-varid'>ct</span>
<a name="line-108"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setCtLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span>
<a name="line-109"></a>                <span class='hs-varid'>mk_err_msg</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span>
<a name="line-110"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-111"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>err_msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprLocErrMsg</span> <span class='hs-varid'>err</span>
<a name="line-112"></a>             <span class='hs-varid'>err_fs</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkFastString</span> <span class='hs-varop'>$</span> <span class='hs-varid'>showSDoc</span> <span class='hs-varid'>dflags</span> <span class='hs-varop'>$</span>
<a name="line-113"></a>                       <span class='hs-varid'>err_msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>text</span> <span class='hs-str'>"(deferred type error)"</span>
<a name="line-114"></a>
<a name="line-115"></a>         <span class='hs-comment'>-- Create the binding</span>
<a name="line-116"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>addTcEvBind</span> <span class='hs-varid'>ev_binds_var</span> <span class='hs-varid'>ev_id</span> <span class='hs-layout'>(</span><span class='hs-conid'>EvDelayedError</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>err_fs</span><span class='hs-layout'>)</span>
<a name="line-117"></a>
<a name="line-118"></a>         <span class='hs-comment'>-- And emit a warning</span>
<a name="line-119"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>reportWarning</span> <span class='hs-layout'>(</span><span class='hs-varid'>makeIntoWarning</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-120"></a>
<a name="line-121"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-comment'>-- Do not set any evidence for Given/Derived</span>
<a name="line-122"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>   
<a name="line-123"></a>
<a name="line-124"></a><a name="reportInsolsAndFlats"></a><span class='hs-definition'>reportInsolsAndFlats</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-125"></a><span class='hs-definition'>reportInsolsAndFlats</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>insols</span> <span class='hs-varid'>flats</span>
<a name="line-126"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tryReporters</span> 
<a name="line-127"></a>      <span class='hs-keyglyph'>[</span> <span class='hs-comment'>-- First deal with things that are utterly wrong</span>
<a name="line-128"></a>        <span class='hs-comment'>-- Like Int ~ Bool (incl nullary TyCons)</span>
<a name="line-129"></a>        <span class='hs-comment'>-- or  Int ~ t a   (AppTy on one side)</span>
<a name="line-130"></a>        <span class='hs-layout'>(</span><span class='hs-str'>"Utterly wrong"</span><span class='hs-layout'>,</span>  <span class='hs-varid'>utterly_wrong</span><span class='hs-layout'>,</span>   <span class='hs-varid'>groupErrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEqErr</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-131"></a>
<a name="line-132"></a>        <span class='hs-comment'>-- Report equalities of form (a~ty).  They are usually</span>
<a name="line-133"></a>        <span class='hs-comment'>-- skolem-equalities, and they cause confusing knock-on </span>
<a name="line-134"></a>        <span class='hs-comment'>-- effects in other errors; see test T4093b.</span>
<a name="line-135"></a>      <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"Skolem equalities"</span><span class='hs-layout'>,</span>    <span class='hs-varid'>skolem_eq</span><span class='hs-layout'>,</span>       <span class='hs-varid'>mkReporter</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEqErr1</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-136"></a>
<a name="line-137"></a>      <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-str'>"Unambiguous"</span><span class='hs-layout'>,</span>          <span class='hs-varid'>unambiguous</span><span class='hs-layout'>,</span>     <span class='hs-varid'>reportFlatErrs</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-138"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>reportAmbigErrs</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-139"></a>      <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-layout'>(</span><span class='hs-varid'>insols</span> <span class='hs-varop'>`unionBags`</span> <span class='hs-varid'>flats</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-140"></a>  <span class='hs-keyword'>where</span>
<a name="line-141"></a>    <span class='hs-varid'>utterly_wrong</span><span class='hs-layout'>,</span> <span class='hs-varid'>skolem_eq</span><span class='hs-layout'>,</span> <span class='hs-varid'>unambiguous</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredTree</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-142"></a>
<a name="line-143"></a>    <span class='hs-varid'>utterly_wrong</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRigid</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isRigid</span> <span class='hs-varid'>ty2</span> 
<a name="line-144"></a>    <span class='hs-varid'>utterly_wrong</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-145"></a>
<a name="line-146"></a>    <span class='hs-varid'>skolem_eq</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRigidOrSkol</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isRigidOrSkol</span> <span class='hs-varid'>ty2</span> 
<a name="line-147"></a>    <span class='hs-varid'>skolem_eq</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-148"></a>
<a name="line-149"></a>    <span class='hs-varid'>unambiguous</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>pred</span> 
<a name="line-150"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>any</span> <span class='hs-varid'>isAmbiguousTyVar</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfCt</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-151"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-152"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 
<a name="line-153"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>pred</span> <span class='hs-keyword'>of</span>
<a name="line-154"></a>          <span class='hs-conid'>EqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>isNothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTyFun_maybe</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isNothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTyFun_maybe</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-155"></a>          <span class='hs-keyword'>_</span>              <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-156"></a>
<a name="line-157"></a><a name="isRigid"></a><span class='hs-comment'>---------------</span>
<a name="line-158"></a><span class='hs-definition'>isRigid</span><span class='hs-layout'>,</span> <span class='hs-varid'>isRigidOrSkol</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-159"></a><span class='hs-definition'>isRigid</span> <span class='hs-varid'>ty</span> 
<a name="line-160"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isDecomposableTyCon</span> <span class='hs-varid'>tc</span>
<a name="line-161"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcSplitAppTy_maybe</span> <span class='hs-varid'>ty</span>        <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-162"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isForAllTy</span> <span class='hs-varid'>ty</span>                           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-163"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                               <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-164"></a>
<a name="line-165"></a><a name="isRigidOrSkol"></a><span class='hs-definition'>isRigidOrSkol</span> <span class='hs-varid'>ty</span> 
<a name="line-166"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getTyVar_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isSkolemTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-167"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isRigid</span> <span class='hs-varid'>ty</span>
<a name="line-168"></a>
<a name="line-169"></a><a name="isTyFun_maybe"></a><span class='hs-definition'>isTyFun_maybe</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>TyCon</span>
<a name="line-170"></a><span class='hs-definition'>isTyFun_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcSplitTyConApp_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-171"></a>                      <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>tc</span><span class='hs-layout'>,</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSynFamilyTyCon</span> <span class='hs-varid'>tc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tc</span>
<a name="line-172"></a>                      <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-173"></a>
<a name="line-174"></a><a name="Reporter"></a><span class='hs-comment'>-----------------</span>
<a name="line-175"></a><a name="Reporter"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>Reporter</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-176"></a>
<a name="line-177"></a><a name="mkReporter"></a><span class='hs-definition'>mkReporter</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-178"></a><span class='hs-comment'>-- Reports errors one at a time</span>
<a name="line-179"></a><span class='hs-definition'>mkReporter</span> <span class='hs-varid'>mk_err</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapM_</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setCtFlavorLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_ev</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-180"></a>                                              <span class='hs-varid'>mk_err</span> <span class='hs-varid'>ct</span><span class='hs-layout'>;</span> 
<a name="line-181"></a>                                     <span class='hs-layout'>;</span> <span class='hs-varid'>reportError</span> <span class='hs-varid'>err</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-182"></a>
<a name="line-183"></a><a name="tryReporters"></a><span class='hs-definition'>tryReporters</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>String</span><span class='hs-layout'>,</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>PredTree</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>Reporter</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Reporter</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Reporter</span>
<a name="line-184"></a><span class='hs-comment'>-- Use the first reporter in the list whose predicate says True</span>
<a name="line-185"></a><span class='hs-definition'>tryReporters</span> <span class='hs-varid'>reporters</span> <span class='hs-varid'>deflt</span> <span class='hs-varid'>cts</span>
<a name="line-186"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tryReporters {"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span> 
<a name="line-187"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>reporters</span> <span class='hs-varid'>cts</span>
<a name="line-188"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tryReporters }"</span> <span class='hs-varid'>empty</span> <span class='hs-layout'>}</span>
<a name="line-189"></a>  <span class='hs-keyword'>where</span>
<a name="line-190"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>deflt</span> <span class='hs-varid'>cts</span> 
<a name="line-191"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>str</span><span class='hs-layout'>,</span> <span class='hs-varid'>pred</span><span class='hs-layout'>,</span> <span class='hs-varid'>reporter</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rs</span><span class='hs-layout'>)</span> <span class='hs-varid'>cts</span>
<a name="line-192"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>yeses</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tryReporters: no"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span> 
<a name="line-193"></a>                      <span class='hs-varid'>go</span> <span class='hs-varid'>rs</span> <span class='hs-varid'>cts</span>
<a name="line-194"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>traceTc</span> <span class='hs-str'>"tryReporters: yes"</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-varid'>str</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>yeses</span><span class='hs-layout'>)</span> <span class='hs-varop'>&gt;&gt;</span> 
<a name="line-195"></a>                      <span class='hs-varid'>reporter</span> <span class='hs-varid'>yeses</span>
<a name="line-196"></a>      <span class='hs-keyword'>where</span>
<a name="line-197"></a>       <span class='hs-varid'>yeses</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>keep_me</span> <span class='hs-varid'>cts</span>
<a name="line-198"></a>       <span class='hs-varid'>keep_me</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pred</span> <span class='hs-varid'>ct</span> <span class='hs-layout'>(</span><span class='hs-varid'>classifyPredType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-199"></a>
<a name="line-200"></a><a name="mkFlatErr"></a><span class='hs-comment'>-----------------</span>
<a name="line-201"></a><span class='hs-definition'>mkFlatErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span>
<a name="line-202"></a><span class='hs-comment'>-- Context is already set</span>
<a name="line-203"></a><span class='hs-definition'>mkFlatErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span>   <span class='hs-comment'>-- The constraint is always wanted</span>
<a name="line-204"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isIPPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkIPErr</span>    <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ct</span><span class='hs-keyglyph'>]</span>
<a name="line-205"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-206"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-207"></a>      <span class='hs-conid'>ClassPred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkDictErr</span>  <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ct</span><span class='hs-keyglyph'>]</span>
<a name="line-208"></a>      <span class='hs-conid'>IrredPred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkIrredErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ct</span><span class='hs-keyglyph'>]</span>
<a name="line-209"></a>      <span class='hs-conid'>EqPred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>mkEqErr1</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span>
<a name="line-210"></a>      <span class='hs-conid'>TuplePred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"mkFlat"</span>
<a name="line-211"></a>      
<a name="line-212"></a><a name="reportAmbigErrs"></a><span class='hs-definition'>reportAmbigErrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Reporter</span>
<a name="line-213"></a><span class='hs-definition'>reportAmbigErrs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>cts</span>
<a name="line-214"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>cec_insol</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-215"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reportFlatErrs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>cts</span>
<a name="line-216"></a>          <span class='hs-comment'>-- Only report ambiguity if no other errors (at all) happened</span>
<a name="line-217"></a>          <span class='hs-comment'>-- See Note [Avoiding spurious errors] in TcSimplify</span>
<a name="line-218"></a>
<a name="line-219"></a><a name="reportFlatErrs"></a><span class='hs-definition'>reportFlatErrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Reporter</span>
<a name="line-220"></a><span class='hs-comment'>-- Called once for non-ambigs, once for ambigs</span>
<a name="line-221"></a><span class='hs-comment'>-- Report equality errors, and others only if we've done all </span>
<a name="line-222"></a><span class='hs-comment'>-- the equalities.  The equality errors are more basic, and</span>
<a name="line-223"></a><span class='hs-comment'>-- can lead to knock on type-class errors</span>
<a name="line-224"></a><span class='hs-definition'>reportFlatErrs</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>cts</span>
<a name="line-225"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tryReporters</span>
<a name="line-226"></a>      <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-str'>"Equalities"</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_equality</span><span class='hs-layout'>,</span> <span class='hs-varid'>groupErrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkEqErr</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-227"></a>      <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>cts</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>dicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>ips</span><span class='hs-layout'>,</span> <span class='hs-varid'>irreds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cts</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span> <span class='hs-conid'>[]</span>
<a name="line-228"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>groupErrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIPErr</span>    <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>ips</span>   
<a name="line-229"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>groupErrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkIrredErr</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>irreds</span>
<a name="line-230"></a>                  <span class='hs-layout'>;</span> <span class='hs-varid'>groupErrs</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkDictErr</span>  <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>dicts</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-231"></a>      <span class='hs-varid'>cts</span>
<a name="line-232"></a>  <span class='hs-keyword'>where</span>
<a name="line-233"></a>    <span class='hs-varid'>is_equality</span> <span class='hs-keyword'>_</span> <span class='hs-layout'>(</span><span class='hs-conid'>EqPred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>True</span>
<a name="line-234"></a>    <span class='hs-varid'>is_equality</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-235"></a>
<a name="line-236"></a>    <span class='hs-varid'>go</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>dicts</span> <span class='hs-varid'>ips</span> <span class='hs-varid'>irreds</span>
<a name="line-237"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>dicts</span><span class='hs-layout'>,</span> <span class='hs-varid'>ips</span><span class='hs-layout'>,</span> <span class='hs-varid'>irreds</span><span class='hs-layout'>)</span>
<a name="line-238"></a>    <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>cts</span><span class='hs-layout'>)</span> <span class='hs-varid'>dicts</span> <span class='hs-varid'>ips</span> <span class='hs-varid'>irreds</span>
<a name="line-239"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isIPPred</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>dicts</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>ips</span><span class='hs-layout'>)</span> <span class='hs-varid'>irreds</span>
<a name="line-240"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-241"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>classifyPredType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-242"></a>          <span class='hs-conid'>ClassPred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cts</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>dicts</span><span class='hs-layout'>)</span> <span class='hs-varid'>ips</span> <span class='hs-varid'>irreds</span>
<a name="line-243"></a>          <span class='hs-conid'>IrredPred</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>cts</span> <span class='hs-varid'>dicts</span> <span class='hs-varid'>ips</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>irreds</span><span class='hs-layout'>)</span>
<a name="line-244"></a>          <span class='hs-keyword'>_</span>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"mkFlat"</span>
<a name="line-245"></a>    <span class='hs-comment'>-- TuplePreds should have been expanded away by the constraint</span>
<a name="line-246"></a>    <span class='hs-comment'>-- simplifier, so they shouldn't show up at this point</span>
<a name="line-247"></a>    <span class='hs-comment'>-- And EqPreds are dealt with by the is_equality test</span>
<a name="line-248"></a>
<a name="line-249"></a>
<a name="line-250"></a><span class='hs-comment'>--------------------------------------------</span>
<a name="line-251"></a><span class='hs-comment'>--      Support code </span>
<a name="line-252"></a><span class='hs-comment'>--------------------------------------------</span>
<a name="line-253"></a>
<a name="line-254"></a><a name="groupErrs"></a><span class='hs-definition'>groupErrs</span> <span class='hs-keyglyph'>::</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span><span class='hs-layout'>)</span>  <span class='hs-comment'>-- Deal with one group</span>
<a name="line-255"></a>	  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span>	           <span class='hs-comment'>-- Unsolved wanteds</span>
<a name="line-256"></a>          <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-257"></a><span class='hs-comment'>-- Group together insts from same location</span>
<a name="line-258"></a><span class='hs-comment'>-- We want to report them together in error messages</span>
<a name="line-259"></a>
<a name="line-260"></a><span class='hs-definition'>groupErrs</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> 
<a name="line-261"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>()</span>
<a name="line-262"></a><span class='hs-definition'>groupErrs</span> <span class='hs-varid'>mk_err</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct1</span> <span class='hs-conop'>:</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span>
<a name="line-263"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>err</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>setCtFlavorLoc</span> <span class='hs-varid'>flavor</span> <span class='hs-varop'>$</span> <span class='hs-varid'>mk_err</span> <span class='hs-varid'>cts</span>
<a name="line-264"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>reportError</span> <span class='hs-varid'>err</span>
<a name="line-265"></a>        <span class='hs-layout'>;</span> <span class='hs-varid'>groupErrs</span> <span class='hs-varid'>mk_err</span> <span class='hs-varid'>others</span> <span class='hs-layout'>}</span>
<a name="line-266"></a>  <span class='hs-keyword'>where</span>
<a name="line-267"></a>   <span class='hs-varid'>flavor</span>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cc_ev</span> <span class='hs-varid'>ct1</span>
<a name="line-268"></a>   <span class='hs-varid'>cts</span>               <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ct1</span> <span class='hs-conop'>:</span> <span class='hs-varid'>friends</span>
<a name="line-269"></a>   <span class='hs-layout'>(</span><span class='hs-varid'>friends</span><span class='hs-layout'>,</span> <span class='hs-varid'>others</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>is_friend</span> <span class='hs-varid'>rest</span>
<a name="line-270"></a>   <span class='hs-varid'>is_friend</span> <span class='hs-varid'>friend</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cc_ev</span> <span class='hs-varid'>friend</span> <span class='hs-varop'>`same_group`</span> <span class='hs-varid'>flavor</span>
<a name="line-271"></a>
<a name="line-272"></a>   <span class='hs-varid'>same_group</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-273"></a>   <span class='hs-varid'>same_group</span> <span class='hs-layout'>(</span><span class='hs-conid'>Given</span>   <span class='hs-layout'>{</span><span class='hs-varid'>ctev_gloc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l1</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Given</span>   <span class='hs-layout'>{</span><span class='hs-varid'>ctev_gloc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l2</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>same_loc</span> <span class='hs-varid'>l1</span> <span class='hs-varid'>l2</span>
<a name="line-274"></a>   <span class='hs-varid'>same_group</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span>  <span class='hs-layout'>{</span><span class='hs-varid'>ctev_wloc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l1</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span>  <span class='hs-layout'>{</span><span class='hs-varid'>ctev_wloc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l2</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>same_loc</span> <span class='hs-varid'>l1</span> <span class='hs-varid'>l2</span>
<a name="line-275"></a>   <span class='hs-varid'>same_group</span> <span class='hs-layout'>(</span><span class='hs-conid'>Derived</span> <span class='hs-layout'>{</span><span class='hs-varid'>ctev_wloc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l1</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>Derived</span> <span class='hs-layout'>{</span><span class='hs-varid'>ctev_wloc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>l2</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>same_loc</span> <span class='hs-varid'>l1</span> <span class='hs-varid'>l2</span>
<a name="line-276"></a>   <span class='hs-varid'>same_group</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-277"></a>
<a name="line-278"></a>   <span class='hs-varid'>same_loc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtLoc</span> <span class='hs-varid'>o</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtLoc</span> <span class='hs-varid'>o</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>
<a name="line-279"></a>   <span class='hs-varid'>same_loc</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>s1</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>CtLoc</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>s2</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>s1</span><span class='hs-varop'>==</span><span class='hs-varid'>s2</span>
<a name="line-280"></a>
<a name="line-281"></a><a name="addArising"></a><span class='hs-comment'>-- Add the "arising from..." part to a message about bunch of dicts</span>
<a name="line-282"></a><span class='hs-definition'>addArising</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-283"></a><span class='hs-definition'>addArising</span> <span class='hs-varid'>orig</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-varid'>msg</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprArising</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
<a name="line-284"></a>
<a name="line-285"></a><a name="pprWithArising"></a><span class='hs-definition'>pprWithArising</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>WantedLoc</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-286"></a><span class='hs-comment'>-- Print something like</span>
<a name="line-287"></a><span class='hs-comment'>--    (Eq a) arising from a use of x at y</span>
<a name="line-288"></a><span class='hs-comment'>--    (Show a) arising from a use of p at q</span>
<a name="line-289"></a><span class='hs-comment'>-- Also return a location for the error message</span>
<a name="line-290"></a><span class='hs-comment'>-- Works for Wanted/Derived only</span>
<a name="line-291"></a><span class='hs-definition'>pprWithArising</span> <span class='hs-conid'>[]</span> 
<a name="line-292"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"pprWithArising"</span>
<a name="line-293"></a><span class='hs-definition'>pprWithArising</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>cts</span><span class='hs-layout'>)</span>
<a name="line-294"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>cts</span>
<a name="line-295"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>addArising</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocOrigin</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctWantedLoc</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-296"></a>                     <span class='hs-layout'>(</span><span class='hs-varid'>pprTheta</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-297"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-298"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ppr_one</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-varid'>cts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-299"></a>  <span class='hs-keyword'>where</span>
<a name="line-300"></a>    <span class='hs-varid'>loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctWantedLoc</span> <span class='hs-varid'>ct</span>
<a name="line-301"></a>    <span class='hs-varid'>ppr_one</span> <span class='hs-varid'>ct</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-302"></a>                    <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprArisingAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctWantedLoc</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-303"></a>
<a name="line-304"></a><a name="mkErrorReport"></a><span class='hs-definition'>mkErrorReport</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span>
<a name="line-305"></a><span class='hs-definition'>mkErrorReport</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkErrTcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_tidy</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>cec_extra</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-306"></a>
<a name="line-307"></a><a name="UserGiven"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>UserGiven</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>GivenLoc</span><span class='hs-layout'>)</span>
<a name="line-308"></a>
<a name="line-309"></a><a name="getUserGivens"></a><span class='hs-definition'>getUserGivens</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UserGiven</span><span class='hs-keyglyph'>]</span>
<a name="line-310"></a><span class='hs-comment'>-- One item for each enclosing implication</span>
<a name="line-311"></a><span class='hs-definition'>getUserGivens</span> <span class='hs-layout'>(</span><span class='hs-conid'>CEC</span> <span class='hs-layout'>{</span><span class='hs-varid'>cec_encl</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-312"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-varop'>$</span>
<a name="line-313"></a>    <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-varid'>givens</span><span class='hs-layout'>,</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Implic</span> <span class='hs-layout'>{</span><span class='hs-varid'>ic_given</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>givens</span><span class='hs-layout'>,</span> <span class='hs-varid'>ic_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>ctxt</span>
<a name="line-314"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>givens</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}

Note [Do not report derived but soluble errors]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
The wc_flats include Derived constraints that have not been solved, but are
not insoluble (in that case they'd be in wc_insols).  We do not want to report
these as errors:

* Superclass constraints. If we have an unsolved [W] Ord a, we'll also have
  an unsolved [D] Eq a, and we do not want to report that; it's just noise.

* Functional dependencies.  For givens, consider
      class C a b | a -> b
      data T a where
         MkT :: C a d => [d] -> T a
      f :: C a b => T a -> F Int
      f (MkT xs) = length xs
  Then we get a [D] b~d.  But there *is* a legitimate call to
  f, namely   f (MkT [True]) :: T Bool, in which b=d.  So we should
  not reject the program.

  For wanteds, something similar
      data T a where
        MkT :: C Int b => a -> b -> T a 
      g :: C Int c => c -> ()
      f :: T a -> ()
      f (MkT x y) = g x
  Here we get [G] C Int b, [W] C Int a, hence [D] a~b.
  But again f (MkT True True) is a legitimate call.

(We leave the Deriveds in wc_flat until reportErrors, so that we don't lose
derived superclasses between iterations of the solver.)

For functional dependencies, here is a real example, 
stripped off from libraries/utf8-string/Codec/Binary/UTF8/Generic.hs

  class C a b | a -> b
  g :: C a b => a -> b -> () 
  f :: C a b => a -> b -> () 
  f xa xb = 
      let loop = g xa 
      in loop xb

We will first try to infer a type for loop, and we will succeed:
    C a b' => b' -> ()
Subsequently, we will type check (loop xb) and all is good. But, 
recall that we have to solve a final implication constraint: 
    C a b => (C a b' => .... cts from body of loop .... )) 
And now we have a problem as we will generate an equality b ~ b' and fail to 
solve it. 


%************************************************************************
%*                  *
                Irreducible predicate errors
%*                  *
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="mkIrredErr"></a><span class='hs-definition'>mkIrredErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span>
<a name="line-2"></a><span class='hs-definition'>mkIrredErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>cts</span> 
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkErrorReport</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>msg</span>
<a name="line-4"></a>  <span class='hs-keyword'>where</span>
<a name="line-5"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ct1</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span>
<a name="line-6"></a>    <span class='hs-varid'>orig</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctWantedLoc</span> <span class='hs-varid'>ct1</span><span class='hs-layout'>)</span>
<a name="line-7"></a>    <span class='hs-varid'>givens</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUserGivens</span> <span class='hs-varid'>ctxt</span>
<a name="line-8"></a>    <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>couldNotDeduce</span> <span class='hs-varid'>givens</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>ctPred</span> <span class='hs-varid'>cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
                Implicit parameter errors
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="mkIPErr"></a><span class='hs-definition'>mkIPErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span>
<a name="line-2"></a><span class='hs-definition'>mkIPErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>cts</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ambig_err</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkAmbigMsg</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>cts</span>
<a name="line-4"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkErrorReport</span> <span class='hs-varid'>ctxt'</span> <span class='hs-layout'>(</span><span class='hs-varid'>msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ambig_err</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-5"></a>  <span class='hs-keyword'>where</span>
<a name="line-6"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ct1</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cts</span>
<a name="line-7"></a>    <span class='hs-varid'>orig</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctWantedLoc</span> <span class='hs-varid'>ct1</span><span class='hs-layout'>)</span>
<a name="line-8"></a>    <span class='hs-varid'>preds</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>ctPred</span> <span class='hs-varid'>cts</span>
<a name="line-9"></a>    <span class='hs-varid'>givens</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUserGivens</span> <span class='hs-varid'>ctxt</span>
<a name="line-10"></a>    <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>givens</span>
<a name="line-11"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>addArising</span> <span class='hs-varid'>orig</span> <span class='hs-varop'>$</span>
<a name="line-12"></a>          <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unbound implicit parameter"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>cts</span>
<a name="line-13"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprTheta</span> <span class='hs-varid'>preds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span> 
<a name="line-14"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-15"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>couldNotDeduce</span> <span class='hs-varid'>givens</span> <span class='hs-layout'>(</span><span class='hs-varid'>preds</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
</pre>\end{code}


%************************************************************************
%*									*
                Equality errors
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="mkEqErr"></a><span class='hs-definition'>mkEqErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span>
<a name="line-2"></a><span class='hs-comment'>-- Don't have multiple equality errors from the same location</span>
<a name="line-3"></a><span class='hs-comment'>-- E.g.   (Int,Bool) ~ (Bool,Int)   one error will do!</span>
<a name="line-4"></a><span class='hs-definition'>mkEqErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEqErr1</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span>
<a name="line-5"></a><span class='hs-definition'>mkEqErr</span> <span class='hs-keyword'>_</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>panic</span> <span class='hs-str'>"mkEqErr"</span>
<a name="line-6"></a>
<a name="line-7"></a><a name="mkEqErr1"></a><span class='hs-definition'>mkEqErr1</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span>
<a name="line-8"></a><span class='hs-comment'>-- Wanted constraints only!</span>
<a name="line-9"></a><span class='hs-definition'>mkEqErr1</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span>
<a name="line-10"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isGiven</span> <span class='hs-varid'>flav</span> <span class='hs-keyword'>then</span> 
<a name="line-11"></a>      <span class='hs-keyword'>let</span> <span class='hs-varid'>ctx2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_extra</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cec_extra</span> <span class='hs-varid'>ctxt</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>inaccessible_msg</span> <span class='hs-varid'>flav</span> <span class='hs-layout'>}</span>
<a name="line-12"></a>      <span class='hs-keyword'>in</span> <span class='hs-varid'>mkEqErr_help</span> <span class='hs-varid'>ctx2</span> <span class='hs-varid'>ct</span> <span class='hs-conid'>False</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-13"></a>    <span class='hs-keyword'>else</span>
<a name="line-14"></a>      <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>orig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-layout'>(</span><span class='hs-varid'>getWantedLoc</span> <span class='hs-varid'>flav</span><span class='hs-layout'>)</span>
<a name="line-15"></a>         <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt1</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyOrigin</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>orig</span>
<a name="line-16"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>mk_err</span> <span class='hs-varid'>ctxt1</span> <span class='hs-varid'>orig'</span> <span class='hs-layout'>}</span>
<a name="line-17"></a>  <span class='hs-keyword'>where</span>
<a name="line-18"></a>
<a name="line-19"></a>    <span class='hs-varid'>flav</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>cc_ev</span> <span class='hs-varid'>ct</span>
<a name="line-20"></a>
<a name="line-21"></a>    <span class='hs-varid'>inaccessible_msg</span> <span class='hs-layout'>(</span><span class='hs-conid'>Given</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_gloc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> 
<a name="line-22"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Inaccessible code in"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-23"></a>            <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-24"></a>    <span class='hs-comment'>-- If a Solved then we should not report inaccessible code</span>
<a name="line-25"></a>    <span class='hs-varid'>inaccessible_msg</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-26"></a>
<a name="line-27"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getEqPredTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-28"></a>
<a name="line-29"></a>       <span class='hs-comment'>-- If the types in the error message are the same as the types</span>
<a name="line-30"></a>       <span class='hs-comment'>-- we are unifying, don't add the extra expected/actual message</span>
<a name="line-31"></a>    <span class='hs-varid'>mk_err</span> <span class='hs-varid'>ctxt1</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnifyOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act</span><span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-32"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>act</span> <span class='hs-varop'>`pickyEqType`</span> <span class='hs-varid'>ty1</span>
<a name="line-33"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>exp</span> <span class='hs-varop'>`pickyEqType`</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEqErr_help</span> <span class='hs-varid'>ctxt1</span> <span class='hs-varid'>ct</span> <span class='hs-conid'>True</span>  <span class='hs-varid'>ty2</span> <span class='hs-varid'>ty1</span>
<a name="line-34"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>exp</span> <span class='hs-varop'>`pickyEqType`</span> <span class='hs-varid'>ty1</span>
<a name="line-35"></a>      <span class='hs-layout'>,</span> <span class='hs-varid'>act</span> <span class='hs-varop'>`pickyEqType`</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEqErr_help</span> <span class='hs-varid'>ctxt1</span> <span class='hs-varid'>ct</span> <span class='hs-conid'>True</span>  <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-36"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEqErr_help</span> <span class='hs-varid'>ctxt2</span> <span class='hs-varid'>ct</span> <span class='hs-conid'>False</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-37"></a>      <span class='hs-keyword'>where</span>
<a name="line-38"></a>        <span class='hs-varid'>ctxt2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt1</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_extra</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>cec_extra</span> <span class='hs-varid'>ctxt1</span> <span class='hs-layout'>}</span>
<a name="line-39"></a>        <span class='hs-varid'>msg</span>   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkExpectedActualMsg</span> <span class='hs-varid'>exp</span> <span class='hs-varid'>act</span>
<a name="line-40"></a>    <span class='hs-varid'>mk_err</span> <span class='hs-varid'>ctxt1</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEqErr_help</span> <span class='hs-varid'>ctxt1</span> <span class='hs-varid'>ct</span> <span class='hs-conid'>False</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-41"></a>
<a name="line-42"></a><a name="mkEqErr_help"></a><span class='hs-definition'>mkEqErr_help</span><span class='hs-layout'>,</span> <span class='hs-varid'>reportEqErr</span> 
<a name="line-43"></a>   <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span>
<a name="line-44"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span>
<a name="line-45"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span>     <span class='hs-comment'>-- True  &lt;=&gt; Types are correct way round;</span>
<a name="line-46"></a>               <span class='hs-comment'>--           report "expected ty1, actual ty2"</span>
<a name="line-47"></a>               <span class='hs-comment'>-- False &lt;=&gt; Just report a mismatch without orientation</span>
<a name="line-48"></a>               <span class='hs-comment'>--           The ReportErrCtxt has expected/actual </span>
<a name="line-49"></a>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span>
<a name="line-50"></a><span class='hs-definition'>mkEqErr_help</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-51"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarEqErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-52"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>ty2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarEqErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>tv2</span> <span class='hs-varid'>ty1</span>
<a name="line-53"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reportEqErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-54"></a>
<a name="line-55"></a><a name="reportEqErr"></a><span class='hs-definition'>reportEqErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-56"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctxt'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkEqInfoMsg</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-57"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkErrorReport</span> <span class='hs-varid'>ctxt'</span> <span class='hs-layout'>(</span><span class='hs-varid'>misMatchOrCND</span> <span class='hs-varid'>ctxt'</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-58"></a>
<a name="line-59"></a><a name="mkTyVarEqErr"></a><span class='hs-definition'>mkTyVarEqErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span>
<a name="line-60"></a><span class='hs-comment'>-- tv1 and ty2 are already tidied</span>
<a name="line-61"></a><span class='hs-definition'>mkTyVarEqErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span>
<a name="line-62"></a>  <span class='hs-keyglyph'>|</span>  <span class='hs-varid'>isSkolemTyVar</span> <span class='hs-varid'>tv1</span> 	  <span class='hs-comment'>-- ty2 won't be a meta-tyvar, or else the thing would</span>
<a name="line-63"></a>     		   	  <span class='hs-comment'>-- be oriented the other way round; see TcCanonical.reOrient</span>
<a name="line-64"></a>  <span class='hs-varop'>||</span> <span class='hs-varid'>isSigTyVar</span> <span class='hs-varid'>tv1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isTyVarTy</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-65"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkErrorReport</span> <span class='hs-layout'>(</span><span class='hs-varid'>addExtraTyVarInfo</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-66"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>misMatchOrCND</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-67"></a>
<a name="line-68"></a>  <span class='hs-comment'>-- So tv is a meta tyvar, and presumably it is</span>
<a name="line-69"></a>  <span class='hs-comment'>-- an *untouchable* meta tyvar, else it'd have been unified</span>
<a name="line-70"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>k2</span> <span class='hs-varop'>`tcIsSubKind`</span> <span class='hs-varid'>k1</span><span class='hs-layout'>)</span>   	 <span class='hs-comment'>-- Kind error</span>
<a name="line-71"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkErrorReport</span> <span class='hs-varid'>ctxt</span> <span class='hs-varop'>$</span> <span class='hs-layout'>(</span><span class='hs-varid'>kindErrorMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-72"></a>
<a name="line-73"></a>  <span class='hs-comment'>-- Occurs check</span>
<a name="line-74"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isNothing</span> <span class='hs-layout'>(</span><span class='hs-varid'>occurCheckExpand</span> <span class='hs-varid'>tv1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-75"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>occCheckMsg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>text</span> <span class='hs-str'>"Occurs check: cannot construct the infinite type:"</span><span class='hs-layout'>)</span> <span class='hs-num'>2</span>
<a name="line-76"></a>                           <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>,</span> <span class='hs-varid'>char</span> <span class='hs-chr'>'='</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-77"></a>    <span class='hs-keyword'>in</span> <span class='hs-varid'>mkErrorReport</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>occCheckMsg</span>
<a name="line-78"></a>
<a name="line-79"></a>  <span class='hs-comment'>-- Check for skolem escape</span>
<a name="line-80"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>implic</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span>   <span class='hs-comment'>-- Get the innermost context</span>
<a name="line-81"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>esc_skols</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-layout'>(</span><span class='hs-varop'>`elemVarSet`</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_skols</span> <span class='hs-varid'>implic</span><span class='hs-layout'>)</span>
<a name="line-82"></a>        <span class='hs-varid'>implic_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_loc</span> <span class='hs-varid'>implic</span>
<a name="line-83"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>esc_skols</span><span class='hs-layout'>)</span>
<a name="line-84"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setCtLoc</span> <span class='hs-varid'>implic_loc</span> <span class='hs-varop'>$</span>	<span class='hs-comment'>-- Override the error message location from the</span>
<a name="line-85"></a>    	     			<span class='hs-comment'>-- place the equality arose to the implication site</span>
<a name="line-86"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt'</span><span class='hs-layout'>,</span> <span class='hs-varid'>env_sigs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findGlobals</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>unitVarSet</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span>
<a name="line-87"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>misMatchMsg</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-88"></a>             <span class='hs-varid'>esc_doc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"because type variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>esc_skols</span>
<a name="line-89"></a>                             <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprQuotedList</span> <span class='hs-varid'>esc_skols</span>
<a name="line-90"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"would escape"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-91"></a>                             <span class='hs-keyword'>if</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>esc_skols</span> <span class='hs-keyword'>then</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"its scope"</span><span class='hs-layout'>)</span>
<a name="line-92"></a>                                                      <span class='hs-keyword'>else</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"their scope"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-93"></a>             <span class='hs-varid'>extra1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>esc_doc</span>
<a name="line-94"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>esc_skols</span> 
<a name="line-95"></a>                                    <span class='hs-keyword'>then</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"This (rigid, skolem) type variable is"</span><span class='hs-layout'>)</span>
<a name="line-96"></a>                                    <span class='hs-keyword'>else</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"These (rigid, skolem) type variables are"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-97"></a>                                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"bound by"</span><span class='hs-layout'>)</span>
<a name="line-98"></a>                                 <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>implic_loc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-99"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkErrorReport</span> <span class='hs-varid'>ctxt'</span> <span class='hs-layout'>(</span><span class='hs-varid'>msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>extra1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>mkEnvSigMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>env_sigs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-100"></a>
<a name="line-101"></a>  <span class='hs-comment'>-- Nastiest case: attempt to unify an untouchable variable</span>
<a name="line-102"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>implic</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span>   <span class='hs-comment'>-- Get the innermost context</span>
<a name="line-103"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>implic_loc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_loc</span> <span class='hs-varid'>implic</span>
<a name="line-104"></a>        <span class='hs-varid'>given</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_given</span> <span class='hs-varid'>implic</span>
<a name="line-105"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setCtLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_loc</span> <span class='hs-varid'>implic</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-106"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>misMatchMsg</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-107"></a>             <span class='hs-varid'>extra</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span>
<a name="line-108"></a>                 <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is untouchable"</span><span class='hs-layout'>)</span>
<a name="line-109"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"inside the constraints"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprEvVarTheta</span> <span class='hs-varid'>given</span>
<a name="line-110"></a>                         <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"bound at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>implic_loc</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-111"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkErrorReport</span> <span class='hs-layout'>(</span><span class='hs-varid'>addExtraTyVarInfo</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varid'>extra</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-112"></a>
<a name="line-113"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-114"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reportEqErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>oriented</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-115"></a>        <span class='hs-comment'>-- This *can* happen (Trac #6123, and test T2627b)</span>
<a name="line-116"></a>        <span class='hs-comment'>-- Consider an ambiguous top-level constraint (a ~ F a)</span>
<a name="line-117"></a>        <span class='hs-comment'>-- Not an occurs check, becuase F is a type function.</span>
<a name="line-118"></a>  <span class='hs-keyword'>where</span>         
<a name="line-119"></a>    <span class='hs-varid'>k1</span> 	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarKind</span> <span class='hs-varid'>tv1</span>
<a name="line-120"></a>    <span class='hs-varid'>k2</span> 	<span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span>
<a name="line-121"></a>    <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>tv1</span>
<a name="line-122"></a>
<a name="line-123"></a><a name="mkEqInfoMsg"></a><span class='hs-definition'>mkEqInfoMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ReportErrCtxt</span>
<a name="line-124"></a><span class='hs-comment'>-- Report (a) ambiguity if either side is a type function application</span>
<a name="line-125"></a><span class='hs-comment'>--            e.g. F a0 ~ Int    </span>
<a name="line-126"></a><span class='hs-comment'>--        (b) warning about injectivity if both sides are the same</span>
<a name="line-127"></a><span class='hs-comment'>--            type function application   F a ~ F b</span>
<a name="line-128"></a><span class='hs-comment'>--            See Note [Non-injective type functions]</span>
<a name="line-129"></a><span class='hs-definition'>mkEqInfoMsg</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-130"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-varid'>ambig_msg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>mb_fun1</span> <span class='hs-varop'>||</span> <span class='hs-varid'>isJust</span> <span class='hs-varid'>mb_fun2</span>
<a name="line-131"></a>                                  <span class='hs-keyword'>then</span> <span class='hs-varid'>mkAmbigMsg</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ct</span><span class='hs-keyglyph'>]</span>
<a name="line-132"></a>                                  <span class='hs-keyword'>else</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<a name="line-133"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt'</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_extra</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyfun_msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>ambig_msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>cec_extra</span> <span class='hs-varid'>ctxt'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-134"></a>  <span class='hs-keyword'>where</span>
<a name="line-135"></a>    <span class='hs-varid'>mb_fun1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTyFun_maybe</span> <span class='hs-varid'>ty1</span>
<a name="line-136"></a>    <span class='hs-varid'>mb_fun2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>isTyFun_maybe</span> <span class='hs-varid'>ty2</span>
<a name="line-137"></a>    <span class='hs-varid'>tyfun_msg</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tc1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mb_fun1</span>
<a name="line-138"></a>              <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tc2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mb_fun2</span>
<a name="line-139"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>tc1</span> <span class='hs-varop'>==</span> <span class='hs-varid'>tc2</span> 
<a name="line-140"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"NB:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tc1</span><span class='hs-layout'>)</span> 
<a name="line-141"></a>                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is a type function, and may not be injective"</span><span class='hs-layout'>)</span>
<a name="line-142"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-143"></a>
<a name="line-144"></a><a name="misMatchOrCND"></a><span class='hs-definition'>misMatchOrCND</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Ct</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-145"></a><span class='hs-comment'>-- If oriented then ty1 is expected, ty2 is actual</span>
<a name="line-146"></a><span class='hs-definition'>misMatchOrCND</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ct</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-147"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>givens</span> <span class='hs-varop'>||</span> 
<a name="line-148"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>isRigid</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isRigid</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> 
<a name="line-149"></a>    <span class='hs-varid'>isGiven</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_ev</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-150"></a>       <span class='hs-comment'>-- If the equality is unconditionally insoluble</span>
<a name="line-151"></a>       <span class='hs-comment'>-- or there is no context, don't report the context</span>
<a name="line-152"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>misMatchMsg</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-153"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>      
<a name="line-154"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>couldNotDeduce</span> <span class='hs-varid'>givens</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-varid'>mkEqPred</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
<a name="line-155"></a>  <span class='hs-keyword'>where</span>
<a name="line-156"></a>    <span class='hs-varid'>givens</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUserGivens</span> <span class='hs-varid'>ctxt</span>
<a name="line-157"></a>    <span class='hs-varid'>orig</span>   <span class='hs-keyglyph'>=</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnifyOrigin</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span>
<a name="line-158"></a>
<a name="line-159"></a><a name="couldNotDeduce"></a><span class='hs-definition'>couldNotDeduce</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>UserGiven</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>ThetaType</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtOrigin</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-160"></a><span class='hs-definition'>couldNotDeduce</span> <span class='hs-varid'>givens</span> <span class='hs-layout'>(</span><span class='hs-varid'>wanteds</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
<a name="line-161"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>addArising</span> <span class='hs-varid'>orig</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Could not deduce"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprTheta</span> <span class='hs-varid'>wanteds</span><span class='hs-layout'>)</span>
<a name="line-162"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp_givens</span> <span class='hs-varid'>givens</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-163"></a>
<a name="line-164"></a><a name="pp_givens"></a><span class='hs-definition'>pp_givens</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>EvVar</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>,</span> <span class='hs-conid'>GivenLoc</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span>
<a name="line-165"></a><span class='hs-definition'>pp_givens</span> <span class='hs-varid'>givens</span> 
<a name="line-166"></a>   <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>givens</span> <span class='hs-keyword'>of</span>
<a name="line-167"></a>         <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-168"></a>         <span class='hs-layout'>(</span><span class='hs-varid'>g</span><span class='hs-conop'>:</span><span class='hs-varid'>gs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span>      <span class='hs-varid'>ppr_given</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"from the context"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>g</span>
<a name="line-169"></a>                 <span class='hs-conop'>:</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_given</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"or from"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>gs</span>
<a name="line-170"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>ppr_given</span> <span class='hs-varid'>herald</span> <span class='hs-layout'>(</span><span class='hs-varid'>gs</span><span class='hs-layout'>,</span><span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-171"></a>           <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>herald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprEvVarTheta</span> <span class='hs-varid'>gs</span><span class='hs-layout'>)</span>
<a name="line-172"></a>                <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"bound by"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span>
<a name="line-173"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocSpan</span> <span class='hs-varid'>loc</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-174"></a>
<a name="line-175"></a><a name="addExtraTyVarInfo"></a><span class='hs-definition'>addExtraTyVarInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>ReportErrCtxt</span>
<a name="line-176"></a><span class='hs-comment'>-- Add on extra info about the types themselves</span>
<a name="line-177"></a><span class='hs-comment'>-- NB: The types themselves are already tidied</span>
<a name="line-178"></a><span class='hs-definition'>addExtraTyVarInfo</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-179"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_extra</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>extra1</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>extra2</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>cec_extra</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>}</span>
<a name="line-180"></a>  <span class='hs-keyword'>where</span>
<a name="line-181"></a>    <span class='hs-varid'>extra1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarExtraInfoMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty1</span>
<a name="line-182"></a>    <span class='hs-varid'>extra2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tyVarExtraInfoMsg</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>ty2</span>
<a name="line-183"></a>
<a name="line-184"></a><a name="tyVarExtraInfoMsg"></a><span class='hs-definition'>tyVarExtraInfoMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Implication</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-185"></a><span class='hs-comment'>-- Shows a bit of extra info about skolem constants</span>
<a name="line-186"></a><span class='hs-definition'>tyVarExtraInfoMsg</span> <span class='hs-varid'>implics</span> <span class='hs-varid'>ty</span>
<a name="line-187"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>ty</span>
<a name="line-188"></a>  <span class='hs-layout'>,</span> <span class='hs-varid'>isTcTyVar</span> <span class='hs-varid'>tv</span><span class='hs-layout'>,</span> <span class='hs-varid'>isSkolemTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-189"></a>  <span class='hs-layout'>,</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>pp_tv</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-190"></a> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>tcTyVarDetails</span> <span class='hs-varid'>tv</span> <span class='hs-keyword'>of</span>
<a name="line-191"></a>    <span class='hs-conid'>SkolemTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pp_tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_skol</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSkolemInfo</span> <span class='hs-varid'>implics</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcLoc</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-192"></a>    <span class='hs-conid'>FlatSkol</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>   <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pp_tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is a flattening type variable"</span><span class='hs-layout'>)</span>
<a name="line-193"></a>    <span class='hs-conid'>RuntimeUnk</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>pp_tv</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is an interactive-debugger skolem"</span><span class='hs-layout'>)</span>
<a name="line-194"></a>    <span class='hs-conid'>MetaTv</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span>     <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>empty</span>
<a name="line-195"></a>
<a name="line-196"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-comment'>-- Normal case</span>
<a name="line-197"></a> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-198"></a> <span class='hs-keyword'>where</span>
<a name="line-199"></a>   <span class='hs-varid'>ppr_skol</span> <span class='hs-varid'>given_loc</span> <span class='hs-varid'>tv_loc</span>
<a name="line-200"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>skol_info</span> <span class='hs-keyword'>of</span>
<a name="line-201"></a>         <span class='hs-conid'>UnkSkol</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is an unknown type variable"</span><span class='hs-layout'>)</span>
<a name="line-202"></a>         <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"is a rigid type variable bound by"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-203"></a>                    <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>skol_info</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv_loc</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-204"></a>     <span class='hs-keyword'>where</span>
<a name="line-205"></a>       <span class='hs-varid'>skol_info</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>given_loc</span>
<a name="line-206"></a> 
<a name="line-207"></a><a name="kindErrorMsg"></a><span class='hs-definition'>kindErrorMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>   <span class='hs-comment'>-- Types are already tidy</span>
<a name="line-208"></a><span class='hs-definition'>kindErrorMsg</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span>
<a name="line-209"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Kind incompatibility when matching types:"</span><span class='hs-layout'>)</span>
<a name="line-210"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k1</span>
<a name="line-211"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-212"></a>  <span class='hs-keyword'>where</span>
<a name="line-213"></a>    <span class='hs-varid'>k1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty1</span>
<a name="line-214"></a>    <span class='hs-varid'>k2</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>typeKind</span> <span class='hs-varid'>ty2</span>
<a name="line-215"></a>
<a name="line-216"></a><a name="misMatchMsg"></a><span class='hs-comment'>--------------------</span>
<a name="line-217"></a><span class='hs-definition'>misMatchMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Bool</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>	   <span class='hs-comment'>-- Types are already tidy</span>
<a name="line-218"></a><span class='hs-comment'>-- If oriented then ty1 is expected, ty2 is actual</span>
<a name="line-219"></a><span class='hs-definition'>misMatchMsg</span> <span class='hs-varid'>oriented</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span> 
<a name="line-220"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>oriented</span>
<a name="line-221"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Couldn't match expected"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>what</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-222"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>12</span> <span class='hs-varop'>$</span>   <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"with actual"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>what</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-223"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-224"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Couldn't match"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>what</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty1</span><span class='hs-layout'>)</span>
<a name="line-225"></a>        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>14</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"with"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-226"></a>  <span class='hs-keyword'>where</span> 
<a name="line-227"></a>    <span class='hs-varid'>what</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isKind</span> <span class='hs-varid'>ty1</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"kind"</span><span class='hs-layout'>)</span>
<a name="line-228"></a>         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"type"</span><span class='hs-layout'>)</span>
<a name="line-229"></a>
<a name="line-230"></a><a name="mkExpectedActualMsg"></a><span class='hs-definition'>mkExpectedActualMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-231"></a><span class='hs-definition'>mkExpectedActualMsg</span> <span class='hs-varid'>exp_ty</span> <span class='hs-varid'>act_ty</span>
<a name="line-232"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"Expected type:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>exp_ty</span>
<a name="line-233"></a>         <span class='hs-layout'>,</span> <span class='hs-varid'>text</span> <span class='hs-str'>"  Actual type:"</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>act_ty</span> <span class='hs-keyglyph'>]</span>
</pre>\end{code}

Note [Non-injective type functions]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
It's very confusing to get a message like
     Couldn't match expected type `Depend s'
            against inferred type `Depend s1'
so mkTyFunInfoMsg adds:
       NB: `Depend' is type function, and hence may not be injective

Warn of loopy local equalities that were dropped.


%************************************************************************
%*									*
                 Type-class errors
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="mkDictErr"></a><span class='hs-definition'>mkDictErr</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>ErrMsg</span>
<a name="line-2"></a><span class='hs-definition'>mkDictErr</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>cts</span> 
<a name="line-3"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>cts</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-4"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>inst_envs</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetInstEnvs</span>
<a name="line-5"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>lookups</span>   <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>lookup_cls_inst</span> <span class='hs-varid'>inst_envs</span><span class='hs-layout'>)</span> <span class='hs-varid'>cts</span>
<a name="line-6"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>no_inst_cts</span><span class='hs-layout'>,</span> <span class='hs-varid'>overlap_cts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>partition</span> <span class='hs-varid'>is_no_inst</span> <span class='hs-varid'>lookups</span>
<a name="line-7"></a>
<a name="line-8"></a>       <span class='hs-comment'>-- Report definite no-instance errors, </span>
<a name="line-9"></a>       <span class='hs-comment'>-- or (iff there are none) overlap errors</span>
<a name="line-10"></a>       <span class='hs-comment'>-- But we report only one of them (hence 'head') becuase they all</span>
<a name="line-11"></a>       <span class='hs-comment'>-- have the same source-location origin, to try avoid a cascade</span>
<a name="line-12"></a>       <span class='hs-comment'>-- of error from one location</span>
<a name="line-13"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>err</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mk_dict_err</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>head</span> <span class='hs-layout'>(</span><span class='hs-varid'>no_inst_cts</span> <span class='hs-varop'>++</span> <span class='hs-varid'>overlap_cts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-14"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>mkErrorReport</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>err</span> <span class='hs-layout'>}</span>
<a name="line-15"></a>  <span class='hs-keyword'>where</span>
<a name="line-16"></a>    <span class='hs-varid'>no_givens</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>getUserGivens</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-17"></a>    <span class='hs-varid'>is_no_inst</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifiers</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-18"></a>      <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>no_givens</span> 
<a name="line-19"></a>      <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>matches</span> 
<a name="line-20"></a>      <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>unifiers</span> <span class='hs-varop'>||</span> <span class='hs-varid'>all</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-varop'>.</span> <span class='hs-varid'>isAmbiguousTyVar</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfCt</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-21"></a>           
<a name="line-22"></a>    <span class='hs-varid'>lookup_cls_inst</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>ct</span>
<a name="line-23"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tys_flat</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>tys</span>
<a name="line-24"></a>                <span class='hs-comment'>-- Note [Flattening in error message generation]</span>
<a name="line-25"></a>           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-varid'>lookupInstEnv</span> <span class='hs-varid'>inst_envs</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys_flat</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-26"></a>      <span class='hs-keyword'>where</span>
<a name="line-27"></a>        <span class='hs-layout'>(</span><span class='hs-varid'>clas</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getClassPredTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="mk_dict_err"></a><span class='hs-definition'>mk_dict_err</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Ct</span><span class='hs-layout'>,</span> <span class='hs-conid'>ClsInstLookupResult</span><span class='hs-layout'>)</span>
<a name="line-30"></a>             <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ReportErrCtxt</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-31"></a><span class='hs-comment'>-- Report an overlap error if this class constraint results</span>
<a name="line-32"></a><span class='hs-comment'>-- from an overlap (returning Left clas), otherwise return (Right pred)</span>
<a name="line-33"></a><span class='hs-definition'>mk_dict_err</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-varid'>ct</span><span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>matches</span><span class='hs-layout'>,</span> <span class='hs-varid'>unifiers</span><span class='hs-layout'>,</span> <span class='hs-varid'>safe_haskell</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-34"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>matches</span>  <span class='hs-comment'>-- No matches but perhaps several unifiers</span>
<a name="line-35"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt'</span><span class='hs-layout'>,</span> <span class='hs-varid'>is_ambig</span><span class='hs-layout'>,</span> <span class='hs-varid'>ambig_msg</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mkAmbigMsg</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ct</span><span class='hs-keyglyph'>]</span>
<a name="line-36"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt'</span><span class='hs-layout'>,</span> <span class='hs-varid'>cannot_resolve_msg</span> <span class='hs-varid'>is_ambig</span> <span class='hs-varid'>ambig_msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-37"></a>
<a name="line-38"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>safe_haskell</span>   <span class='hs-comment'>-- Some matches =&gt; overlap errors</span>
<a name="line-39"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>overlap_msg</span><span class='hs-layout'>)</span>
<a name="line-40"></a>
<a name="line-41"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-42"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>safe_haskell_msg</span><span class='hs-layout'>)</span>
<a name="line-43"></a>  <span class='hs-keyword'>where</span>
<a name="line-44"></a>    <span class='hs-varid'>orig</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctWantedLoc</span> <span class='hs-varid'>ct</span><span class='hs-layout'>)</span>
<a name="line-45"></a>    <span class='hs-varid'>pred</span>        <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ctPred</span> <span class='hs-varid'>ct</span>
<a name="line-46"></a>    <span class='hs-layout'>(</span><span class='hs-varid'>clas</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getClassPredTys</span> <span class='hs-varid'>pred</span>
<a name="line-47"></a>    <span class='hs-varid'>ispecs</span>      <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ispec</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>ispec</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matches</span><span class='hs-keyglyph'>]</span>
<a name="line-48"></a>    <span class='hs-varid'>givens</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUserGivens</span> <span class='hs-varid'>ctxt</span>
<a name="line-49"></a>    <span class='hs-varid'>all_tyvars</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>all</span> <span class='hs-varid'>isTyVarTy</span> <span class='hs-varid'>tys</span>
<a name="line-50"></a>
<a name="line-51"></a>    <span class='hs-varid'>cannot_resolve_msg</span> <span class='hs-varid'>has_ambig_tvs</span> <span class='hs-varid'>ambig_msg</span>
<a name="line-52"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>addArising</span> <span class='hs-varid'>orig</span> <span class='hs-layout'>(</span><span class='hs-varid'>no_inst_herald</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>pred</span><span class='hs-layout'>)</span>
<a name="line-53"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp_givens</span> <span class='hs-varid'>givens</span><span class='hs-layout'>)</span>
<a name="line-54"></a>             <span class='hs-layout'>,</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>has_ambig_tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-layout'>(</span><span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>unifiers</span><span class='hs-layout'>)</span> <span class='hs-varop'>||</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>givens</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-55"></a>               <span class='hs-keyword'>then</span> <span class='hs-varid'>ambig_msg</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>potential_msg</span>
<a name="line-56"></a>               <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span>
<a name="line-57"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>show_fixes</span> <span class='hs-layout'>(</span><span class='hs-varid'>inst_decl_fixes</span>
<a name="line-58"></a>                           <span class='hs-varop'>++</span> <span class='hs-varid'>add_to_ctxt_fixes</span> <span class='hs-varid'>has_ambig_tvs</span>
<a name="line-59"></a>                           <span class='hs-varop'>++</span> <span class='hs-varid'>drv_fixes</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-60"></a>
<a name="line-61"></a>    <span class='hs-varid'>potential_msg</span>
<a name="line-62"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>unifiers</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-63"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 
<a name="line-64"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-keyword'>if</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>unifiers</span> 
<a name="line-65"></a>              <span class='hs-keyword'>then</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Note: there is a potential instance available:"</span><span class='hs-layout'>)</span>
<a name="line-66"></a>              <span class='hs-keyword'>else</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Note: there are several potential instances:"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-67"></a>    	   <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr_insts</span> <span class='hs-varid'>unifiers</span><span class='hs-layout'>)</span>
<a name="line-68"></a>
<a name="line-69"></a>    <span class='hs-varid'>add_to_ctxt_fixes</span> <span class='hs-varid'>has_ambig_tvs</span>
<a name="line-70"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-varid'>has_ambig_tvs</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>all_tyvars</span>
<a name="line-71"></a>      <span class='hs-layout'>,</span> <span class='hs-layout'>(</span><span class='hs-varid'>orig</span><span class='hs-conop'>:</span><span class='hs-varid'>origs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapCatMaybes</span> <span class='hs-varid'>get_good_orig</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span>
<a name="line-72"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"add"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>pred</span>
<a name="line-73"></a>               <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"to the context of"</span><span class='hs-layout'>)</span>
<a name="line-74"></a>	     <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ppr_skol</span> <span class='hs-varid'>orig</span> <span class='hs-varop'>$$</span> 
<a name="line-75"></a>                        <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"or"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr_skol</span> <span class='hs-varid'>orig</span> 
<a name="line-76"></a>                             <span class='hs-keyglyph'>|</span> <span class='hs-varid'>orig</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>origs</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-77"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-78"></a>
<a name="line-79"></a>    <span class='hs-varid'>ppr_skol</span> <span class='hs-layout'>(</span><span class='hs-conid'>PatSkol</span> <span class='hs-varid'>dc</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"the data constructor"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>dc</span><span class='hs-layout'>)</span>
<a name="line-80"></a>    <span class='hs-varid'>ppr_skol</span> <span class='hs-varid'>skol_info</span>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>skol_info</span>
<a name="line-81"></a>
<a name="line-82"></a>	<span class='hs-comment'>-- Do not suggest adding constraints to an *inferred* type signature!</span>
<a name="line-83"></a>    <span class='hs-varid'>get_good_orig</span> <span class='hs-varid'>ic</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ctLocOrigin</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_loc</span> <span class='hs-varid'>ic</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span> 
<a name="line-84"></a>                             <span class='hs-conid'>SigSkol</span> <span class='hs-layout'>(</span><span class='hs-conid'>InfSigCtxt</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-85"></a>                             <span class='hs-varid'>origin</span>                    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>origin</span>
<a name="line-86"></a>
<a name="line-87"></a>    <span class='hs-varid'>no_inst_herald</span>
<a name="line-88"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>givens</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>matches</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"No instance for"</span><span class='hs-layout'>)</span>
<a name="line-89"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                   <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Could not deduce"</span><span class='hs-layout'>)</span>
<a name="line-90"></a>
<a name="line-91"></a>    <span class='hs-varid'>inst_decl_fixes</span>
<a name="line-92"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>all_tyvars</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-93"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>  <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"add an instance declaration for"</span><span class='hs-layout'>)</span>
<a name="line-94"></a>                           <span class='hs-layout'>,</span> <span class='hs-varid'>pprParendType</span> <span class='hs-varid'>pred</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>]</span>
<a name="line-95"></a>
<a name="line-96"></a>    <span class='hs-varid'>drv_fixes</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>orig</span> <span class='hs-keyword'>of</span>
<a name="line-97"></a>                   <span class='hs-conid'>DerivOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>drv_fix</span><span class='hs-keyglyph'>]</span>
<a name="line-98"></a>                   <span class='hs-keyword'>_</span>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>[]</span>
<a name="line-99"></a>
<a name="line-100"></a>    <span class='hs-varid'>drv_fix</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"use a standalone 'deriving instance' declaration,"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-101"></a>                 <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"so you can specify the instance context yourself"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-102"></a>
<a name="line-103"></a>    <span class='hs-comment'>-- Normal overlap error</span>
<a name="line-104"></a>    <span class='hs-varid'>overlap_msg</span>
<a name="line-105"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span> <span class='hs-layout'>)</span>
<a name="line-106"></a>        <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span>	<span class='hs-varid'>addArising</span> <span class='hs-varid'>orig</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Overlapping instances for"</span><span class='hs-layout'>)</span> 
<a name="line-107"></a>				<span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-108"></a>
<a name="line-109"></a>             <span class='hs-layout'>,</span>  <span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>null</span> <span class='hs-varid'>matching_givens</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span> 
<a name="line-110"></a>                  <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Matching givens (or their superclasses):"</span><span class='hs-layout'>)</span> 
<a name="line-111"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-varid'>matching_givens</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-112"></a>                <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span>
<a name="line-113"></a>
<a name="line-114"></a>    	     <span class='hs-layout'>,</span>	<span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Matching instances:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-115"></a>    		     <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprInstances</span> <span class='hs-varid'>ispecs</span><span class='hs-layout'>,</span> <span class='hs-varid'>pprInstances</span> <span class='hs-varid'>unifiers</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-116"></a>
<a name="line-117"></a>             <span class='hs-layout'>,</span>  <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-varid'>matching_givens</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>matches</span> <span class='hs-varop'>&amp;&amp;</span> <span class='hs-varid'>null</span> <span class='hs-varid'>unifiers</span> <span class='hs-keyword'>then</span>
<a name="line-118"></a>                <span class='hs-comment'>-- Intuitively, some given matched the wanted in their</span>
<a name="line-119"></a>                <span class='hs-comment'>-- flattened or rewritten (from given equalities) form</span>
<a name="line-120"></a>                <span class='hs-comment'>-- but the matcher can't figure that out because the</span>
<a name="line-121"></a>                <span class='hs-comment'>-- constraints are non-flat and non-rewritten so we</span>
<a name="line-122"></a>                <span class='hs-comment'>-- simply report back the whole given</span>
<a name="line-123"></a>                <span class='hs-comment'>-- context. Accelerate Smart.hs showed this problem.</span>
<a name="line-124"></a>                  <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"There exists a (perhaps superclass) match:"</span><span class='hs-layout'>)</span> 
<a name="line-125"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>pp_givens</span> <span class='hs-varid'>givens</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-126"></a>                <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span> 
<a name="line-127"></a>
<a name="line-128"></a>	     <span class='hs-layout'>,</span>	<span class='hs-keyword'>if</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSingleton</span> <span class='hs-varid'>matches</span><span class='hs-layout'>)</span>
<a name="line-129"></a>    		<span class='hs-keyword'>then</span> 	<span class='hs-comment'>-- Two or more matches</span>
<a name="line-130"></a>		     <span class='hs-varid'>empty</span>
<a name="line-131"></a>    		<span class='hs-keyword'>else</span> 	<span class='hs-comment'>-- One match</span>
<a name="line-132"></a>		<span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The choice depends on the instantiation of"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-133"></a>	    		         <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprWithCommas</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>varSetElems</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-134"></a>			      <span class='hs-keyword'>if</span> <span class='hs-varid'>null</span> <span class='hs-layout'>(</span><span class='hs-varid'>matching_givens</span><span class='hs-layout'>)</span> <span class='hs-keyword'>then</span>
<a name="line-135"></a>                                   <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"To pick the first instance above, use -XIncoherentInstances"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-136"></a>			                  <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"when compiling the other instance declarations"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-137"></a>                              <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-138"></a>        <span class='hs-keyword'>where</span>
<a name="line-139"></a>            <span class='hs-varid'>ispecs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ispec</span> <span class='hs-keyglyph'>|</span> <span class='hs-layout'>(</span><span class='hs-varid'>ispec</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>matches</span><span class='hs-keyglyph'>]</span>
<a name="line-140"></a>
<a name="line-141"></a>            <span class='hs-varid'>givens</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getUserGivens</span> <span class='hs-varid'>ctxt</span>
<a name="line-142"></a>            <span class='hs-varid'>matching_givens</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapCatMaybes</span> <span class='hs-varid'>matchable</span> <span class='hs-varid'>givens</span>
<a name="line-143"></a>
<a name="line-144"></a>            <span class='hs-varid'>matchable</span> <span class='hs-layout'>(</span><span class='hs-varid'>evvars</span><span class='hs-layout'>,</span><span class='hs-varid'>gloc</span><span class='hs-layout'>)</span> 
<a name="line-145"></a>              <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>ev_vars_matching</span> <span class='hs-keyword'>of</span>
<a name="line-146"></a>                     <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Nothing</span>
<a name="line-147"></a>                     <span class='hs-keyword'>_</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Just</span> <span class='hs-varop'>$</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprTheta</span> <span class='hs-varid'>ev_vars_matching</span><span class='hs-layout'>)</span>
<a name="line-148"></a>                                    <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"bound by"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocOrigin</span> <span class='hs-varid'>gloc</span><span class='hs-layout'>)</span>
<a name="line-149"></a>                                           <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctLocSpan</span> <span class='hs-varid'>gloc</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-150"></a>                <span class='hs-keyword'>where</span> <span class='hs-varid'>ev_vars_matching</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>filter</span> <span class='hs-varid'>ev_var_matches</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>evVarPred</span> <span class='hs-varid'>evvars</span><span class='hs-layout'>)</span>
<a name="line-151"></a>                      <span class='hs-varid'>ev_var_matches</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>getClassPredTys_maybe</span> <span class='hs-varid'>ty</span> <span class='hs-keyword'>of</span>
<a name="line-152"></a>                         <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>clas'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
<a name="line-153"></a>                           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>clas'</span> <span class='hs-varop'>==</span> <span class='hs-varid'>clas</span>
<a name="line-154"></a>                           <span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcMatchTys</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyVarsOfTypes</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span> <span class='hs-varid'>tys'</span>
<a name="line-155"></a>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>True</span> 
<a name="line-156"></a>                           <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-157"></a>                           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>any</span> <span class='hs-varid'>ev_var_matches</span> <span class='hs-layout'>(</span><span class='hs-varid'>immSuperClasses</span> <span class='hs-varid'>clas'</span> <span class='hs-varid'>tys'</span><span class='hs-layout'>)</span>
<a name="line-158"></a>                         <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>False</span>
<a name="line-159"></a>
<a name="line-160"></a>    <span class='hs-comment'>-- Overlap error because of Safe Haskell (first </span>
<a name="line-161"></a>    <span class='hs-comment'>-- match should be the most specific match)</span>
<a name="line-162"></a>    <span class='hs-varid'>safe_haskell_msg</span>
<a name="line-163"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-conid'>ASSERT</span><span class='hs-layout'>(</span> <span class='hs-varid'>length</span> <span class='hs-varid'>matches</span> <span class='hs-varop'>&gt;</span> <span class='hs-num'>1</span> <span class='hs-layout'>)</span>
<a name="line-164"></a>        <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>addArising</span> <span class='hs-varid'>orig</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Unsafe overlapping instances for"</span><span class='hs-layout'>)</span> 
<a name="line-165"></a>                        <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprType</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkClassPred</span> <span class='hs-varid'>clas</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-166"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The matching instance is:"</span><span class='hs-layout'>)</span><span class='hs-layout'>,</span>
<a name="line-167"></a>                    <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>pprInstance</span> <span class='hs-varop'>$</span> <span class='hs-varid'>head</span> <span class='hs-varid'>ispecs</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-168"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"It is compiled in a Safe module and as such can only"</span>
<a name="line-169"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"overlap instances from the same module, however it"</span>
<a name="line-170"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-varop'>$</span> <span class='hs-varid'>sLit</span> <span class='hs-str'>"overlaps the following instances from different modules:"</span>
<a name="line-171"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>pprInstances</span> <span class='hs-varop'>$</span> <span class='hs-varid'>tail</span> <span class='hs-varid'>ispecs</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-172"></a>                    <span class='hs-keyglyph'>]</span>
<a name="line-173"></a>             <span class='hs-keyglyph'>]</span>
<a name="line-174"></a>
<a name="line-175"></a><a name="show_fixes"></a><span class='hs-definition'>show_fixes</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-176"></a><span class='hs-definition'>show_fixes</span> <span class='hs-conid'>[]</span>     <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-177"></a><span class='hs-definition'>show_fixes</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span><span class='hs-conop'>:</span><span class='hs-varid'>fs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Possible fix:"</span><span class='hs-layout'>)</span>
<a name="line-178"></a>                        <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>f</span> <span class='hs-conop'>:</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"or"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span><span class='hs-layout'>)</span> <span class='hs-varid'>fs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-179"></a>
<a name="line-180"></a><a name="ppr_insts"></a><span class='hs-definition'>ppr_insts</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>ClsInst</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-181"></a><span class='hs-definition'>ppr_insts</span> <span class='hs-varid'>insts</span>
<a name="line-182"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprInstances</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-num'>3</span> <span class='hs-varid'>insts</span><span class='hs-layout'>)</span> <span class='hs-varop'>$$</span> <span class='hs-varid'>dot_dot_message</span>
<a name="line-183"></a>  <span class='hs-keyword'>where</span>
<a name="line-184"></a>    <span class='hs-varid'>n_extra</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-varid'>insts</span> <span class='hs-comment'>-</span> <span class='hs-num'>3</span>
<a name="line-185"></a>    <span class='hs-varid'>dot_dot_message</span> 
<a name="line-186"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n_extra</span> <span class='hs-varop'>&lt;=</span> <span class='hs-num'>0</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-187"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"...plus"</span><span class='hs-layout'>)</span> 
<a name="line-188"></a>                        <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>speakNOf</span> <span class='hs-varid'>n_extra</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"other"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-189"></a>
<a name="line-190"></a><a name="quickFlattenTy"></a><span class='hs-comment'>----------------------</span>
<a name="line-191"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>TcType</span>
<a name="line-192"></a><span class='hs-comment'>-- See Note [Flattening in error message generation]</span>
<a name="line-193"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcView</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>ty'</span>
<a name="line-194"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>TyVarTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>
<a name="line-195"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>ForAllTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>     <span class='hs-comment'>-- See</span>
<a name="line-196"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-varid'>ty</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LitTy</span> <span class='hs-layout'>{</span><span class='hs-layout'>}</span><span class='hs-layout'>)</span>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varid'>ty</span>
<a name="line-197"></a>  <span class='hs-comment'>-- Don't flatten because of the danger or removing a bound variable</span>
<a name="line-198"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fy1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>ty1</span>
<a name="line-199"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>fy2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>ty2</span>
<a name="line-200"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>AppTy</span> <span class='hs-varid'>fy1</span> <span class='hs-varid'>fy2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-201"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>ty1</span> <span class='hs-varid'>ty2</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fy1</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>ty1</span>
<a name="line-202"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>fy2</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>ty2</span>
<a name="line-203"></a>                                    <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>FunTy</span> <span class='hs-varid'>fy1</span> <span class='hs-varid'>fy2</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-204"></a><span class='hs-definition'>quickFlattenTy</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>tys</span><span class='hs-layout'>)</span>
<a name="line-205"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>not</span> <span class='hs-layout'>(</span><span class='hs-varid'>isSynFamilyTyCon</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span>
<a name="line-206"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>fys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>tys</span> 
<a name="line-207"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>fys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-208"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-209"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>funtys</span><span class='hs-layout'>,</span><span class='hs-varid'>resttys</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>splitAt</span> <span class='hs-layout'>(</span><span class='hs-varid'>tyConArity</span> <span class='hs-varid'>tc</span><span class='hs-layout'>)</span> <span class='hs-varid'>tys</span>
<a name="line-210"></a>                <span class='hs-comment'>-- Ignore the arguments of the type family funtys</span>
<a name="line-211"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>v</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>newMetaTyVar</span> <span class='hs-conid'>TauTv</span> <span class='hs-layout'>(</span><span class='hs-varid'>typeKind</span> <span class='hs-layout'>(</span><span class='hs-conid'>TyConApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>funtys</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-212"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>flat_resttys</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>quickFlattenTy</span> <span class='hs-varid'>resttys</span>
<a name="line-213"></a>         <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>foldl</span> <span class='hs-conid'>AppTy</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkTyVarTy</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-varid'>flat_resttys</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Flattening in error message generation]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Consider (C (Maybe (F x))), where F is a type function, and we have
instances
                C (Maybe Int) and C (Maybe a)
Since (F x) might turn into Int, this is an overlap situation, and
indeed (because of flattening) the main solver will have refrained
from solving.  But by the time we get to error message generation, we've
un-flattened the constraint.  So we must *re*-flatten it before looking
up in the instance environment, lest we only report one matching
instance when in fact there are two.

Re-flattening is pretty easy, because we don't need to keep track of
evidence.  We don't re-use the code in TcCanonical because that's in
the TcS monad, and we are in TcM here.

Note [Quick-flatten polytypes]
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
If we see C (Ix a => blah) or C (forall a. blah) we simply refrain from
flattening any further.  After all, there can be no instance declarations
that match such things.  And flattening under a for-all is problematic
anyway; consider C (forall a. F a)

\begin{code}
<pre><a name="line-1"></a><a name="mkAmbigMsg"></a><span class='hs-definition'>mkAmbigMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> 
<a name="line-2"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ReportErrCtxt</span><span class='hs-layout'>,</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>,</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-3"></a><span class='hs-definition'>mkAmbigMsg</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>cts</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isEmptyVarSet</span> <span class='hs-varid'>ambig_tv_set</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-conid'>False</span><span class='hs-layout'>,</span> <span class='hs-varid'>empty</span><span class='hs-layout'>)</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>dflags</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>getDynFlags</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt'</span><span class='hs-layout'>,</span> <span class='hs-varid'>gbl_docs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>findGlobals</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>ambig_tv_set</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt'</span><span class='hs-layout'>,</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>mk_msg</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>gbl_docs</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>  <span class='hs-keyword'>where</span>
<a name="line-11"></a>    <span class='hs-varid'>ambig_tv_set</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>filterVarSet</span> <span class='hs-varid'>isAmbiguousTyVar</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarsOfCt</span><span class='hs-layout'>)</span> 
<a name="line-12"></a>                         <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>cts</span>
<a name="line-13"></a>    <span class='hs-varid'>ambig_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>varSetElems</span> <span class='hs-varid'>ambig_tv_set</span>
<a name="line-14"></a>    
<a name="line-15"></a>    <span class='hs-varid'>is_or_are</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>isSingleton</span> <span class='hs-varid'>ambig_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"is"</span>
<a name="line-16"></a>              <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>text</span> <span class='hs-str'>"are"</span>
<a name="line-17"></a>                 
<a name="line-18"></a>    <span class='hs-varid'>mk_msg</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>docs</span> 
<a name="line-19"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>any</span> <span class='hs-varid'>isRuntimeUnkSkol</span> <span class='hs-varid'>ambig_tvs</span>  <span class='hs-comment'>-- See Note [Runtime skolems]</span>
<a name="line-20"></a>      <span class='hs-keyglyph'>=</span>  <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Cannot resolve unknown runtime type"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>ambig_tvs</span>
<a name="line-21"></a>                   <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprQuotedList</span> <span class='hs-varid'>ambig_tvs</span>
<a name="line-22"></a>              <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use :print or :force to determine these types"</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-23"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-24"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>text</span> <span class='hs-str'>"The type variable"</span> <span class='hs-varop'>&lt;&gt;</span> <span class='hs-varid'>plural</span> <span class='hs-varid'>ambig_tvs</span>
<a name="line-25"></a>	          <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>pprQuotedList</span> <span class='hs-varid'>ambig_tvs</span>
<a name="line-26"></a>                  <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>is_or_are</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>text</span> <span class='hs-str'>"ambiguous"</span>
<a name="line-27"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>mk_extra_msg</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>docs</span> <span class='hs-keyglyph'>]</span>
<a name="line-28"></a>  
<a name="line-29"></a>    <span class='hs-varid'>mk_extra_msg</span> <span class='hs-varid'>dflags</span> <span class='hs-varid'>docs</span>
<a name="line-30"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>docs</span>
<a name="line-31"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Possible fix: add a type signature that fixes these type variable(s)"</span><span class='hs-layout'>)</span>
<a name="line-32"></a>			<span class='hs-comment'>-- This happens in things like</span>
<a name="line-33"></a>			<span class='hs-comment'>--	f x = show (read "foo")</span>
<a name="line-34"></a>			<span class='hs-comment'>-- where monomorphism doesn't play any role</span>
<a name="line-35"></a>      <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> 
<a name="line-36"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Possible cause: the monomorphism restriction applied to the following:"</span><span class='hs-layout'>)</span>
<a name="line-37"></a>	     <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-varid'>docs</span><span class='hs-layout'>)</span>
<a name="line-38"></a>             <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Probable fix:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>vcat</span>
<a name="line-39"></a>     	          <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"give these definition(s) an explicit type signature"</span><span class='hs-layout'>)</span>
<a name="line-40"></a>     	          <span class='hs-layout'>,</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>xopt</span> <span class='hs-conid'>Opt_MonomorphismRestriction</span> <span class='hs-varid'>dflags</span>
<a name="line-41"></a>                    <span class='hs-keyword'>then</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"or use -XNoMonomorphismRestriction"</span><span class='hs-layout'>)</span>
<a name="line-42"></a>                    <span class='hs-keyword'>else</span> <span class='hs-varid'>empty</span> <span class='hs-keyglyph'>]</span>    <span class='hs-comment'>-- Only suggest adding "-XNoMonomorphismRestriction"</span>
<a name="line-43"></a>     			            <span class='hs-comment'>-- if it is not already set!</span>
<a name="line-44"></a>             <span class='hs-keyglyph'>]</span>
<a name="line-45"></a>
<a name="line-46"></a><a name="getSkolemInfo"></a><span class='hs-definition'>getSkolemInfo</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Implication</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVar</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>GivenLoc</span>
<a name="line-47"></a><span class='hs-comment'>-- Get the skolem info for a type variable </span>
<a name="line-48"></a><span class='hs-comment'>-- from the implication constraint that binds it</span>
<a name="line-49"></a><span class='hs-definition'>getSkolemInfo</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>tv</span>
<a name="line-50"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-conid'>WARN</span><span class='hs-layout'>(</span> <span class='hs-conid'>True</span><span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"No skolem info:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tv</span> <span class='hs-layout'>)</span>
<a name="line-51"></a>    <span class='hs-conid'>CtLoc</span> <span class='hs-conid'>UnkSkol</span> <span class='hs-varid'>noSrcSpan</span> <span class='hs-conid'>[]</span>
<a name="line-52"></a>
<a name="line-53"></a><span class='hs-definition'>getSkolemInfo</span> <span class='hs-layout'>(</span><span class='hs-varid'>implic</span><span class='hs-conop'>:</span><span class='hs-varid'>implics</span><span class='hs-layout'>)</span> <span class='hs-varid'>tv</span>
<a name="line-54"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>tv</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>ic_skols</span> <span class='hs-varid'>implic</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>ic_loc</span> <span class='hs-varid'>implic</span>
<a name="line-55"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>                 <span class='hs-keyglyph'>=</span> <span class='hs-varid'>getSkolemInfo</span> <span class='hs-varid'>implics</span> <span class='hs-varid'>tv</span>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-comment'>-----------------------</span>
<a name="line-58"></a><span class='hs-comment'>-- findGlobals looks at the value environment and finds values whose</span>
<a name="line-59"></a><span class='hs-comment'>-- types mention any of the offending type variables.  It has to be</span>
<a name="line-60"></a><span class='hs-comment'>-- careful to zonk the Id's type first, so it has to be in the monad.</span>
<a name="line-61"></a><span class='hs-comment'>-- We must be careful to pass it a zonked type variable, too.</span>
<a name="line-62"></a>
<a name="line-63"></a><a name="mkEnvSigMsg"></a><span class='hs-definition'>mkEnvSigMsg</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>SDoc</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>SDoc</span>
<a name="line-64"></a><span class='hs-definition'>mkEnvSigMsg</span> <span class='hs-varid'>what</span> <span class='hs-varid'>env_sigs</span>
<a name="line-65"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>env_sigs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-66"></a> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"The following variables have types that mention"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>what</span>
<a name="line-67"></a>                    <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-varid'>env_sigs</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-68"></a>
<a name="line-69"></a><a name="findGlobals"></a><span class='hs-definition'>findGlobals</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span>
<a name="line-70"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyVarSet</span>
<a name="line-71"></a>            <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ReportErrCtxt</span><span class='hs-layout'>,</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>SDoc</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-72"></a>
<a name="line-73"></a><span class='hs-definition'>findGlobals</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>tvs</span> 
<a name="line-74"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>lcl_ty_env</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>cec_encl</span> <span class='hs-varid'>ctxt</span> <span class='hs-keyword'>of</span> 
<a name="line-75"></a>                        <span class='hs-conid'>[]</span>    <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>getLclTypeEnv</span>
<a name="line-76"></a>                        <span class='hs-layout'>(</span><span class='hs-varid'>i</span><span class='hs-conop'>:</span><span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ic_env</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span>
<a name="line-77"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>go</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_tidy</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span> <span class='hs-layout'>(</span><span class='hs-varid'>nameEnvElts</span> <span class='hs-varid'>lcl_ty_env</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-78"></a>  <span class='hs-keyword'>where</span>
<a name="line-79"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>acc</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_tidy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidy_env</span> <span class='hs-layout'>}</span><span class='hs-layout'>,</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-80"></a>    <span class='hs-varid'>go</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>acc</span> <span class='hs-layout'>(</span><span class='hs-varid'>thing</span> <span class='hs-conop'>:</span> <span class='hs-varid'>things</span><span class='hs-layout'>)</span>
<a name="line-81"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>maybe_doc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>find_thing</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>ignore_it</span> <span class='hs-varid'>thing</span>
<a name="line-82"></a>	    <span class='hs-layout'>;</span> <span class='hs-keyword'>case</span> <span class='hs-varid'>maybe_doc</span> <span class='hs-keyword'>of</span>
<a name="line-83"></a>	        <span class='hs-conid'>Just</span> <span class='hs-varid'>d</span>  <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tidy_env1</span> <span class='hs-layout'>(</span><span class='hs-varid'>d</span><span class='hs-conop'>:</span><span class='hs-varid'>acc</span><span class='hs-layout'>)</span> <span class='hs-varid'>things</span>
<a name="line-84"></a>	        <span class='hs-conid'>Nothing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>go</span> <span class='hs-varid'>tidy_env1</span> <span class='hs-varid'>acc</span>     <span class='hs-varid'>things</span> <span class='hs-layout'>}</span>
<a name="line-85"></a>
<a name="line-86"></a>    <span class='hs-varid'>ignore_it</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tvs</span> <span class='hs-varop'>`disjointVarSet`</span> <span class='hs-varid'>tyVarsOfType</span> <span class='hs-varid'>ty</span>
<a name="line-87"></a>
<a name="line-88"></a><a name="find_thing"></a><span class='hs-comment'>-----------------------</span>
<a name="line-89"></a><span class='hs-definition'>find_thing</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Bool</span><span class='hs-layout'>)</span>
<a name="line-90"></a>           <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcTyThing</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>Maybe</span> <span class='hs-conid'>SDoc</span><span class='hs-layout'>)</span>
<a name="line-91"></a><span class='hs-definition'>find_thing</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>ignore_it</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATcId</span> <span class='hs-layout'>{</span> <span class='hs-varid'>tct_id</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>id</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span>
<a name="line-92"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-layout'>(</span><span class='hs-varid'>idType</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span>
<a name="line-93"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>ignore_it</span> <span class='hs-varid'>tidy_ty</span> <span class='hs-keyword'>then</span>
<a name="line-94"></a>	   <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-95"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span> 
<a name="line-96"></a>       <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>id</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>dcolon</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tidy_ty</span>
<a name="line-97"></a>		       <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>parens</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"bound at"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span>
<a name="line-98"></a>			 	   <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcLoc</span> <span class='hs-varid'>id</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-99"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env'</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-100"></a>
<a name="line-101"></a><span class='hs-definition'>find_thing</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>ignore_it</span> <span class='hs-layout'>(</span><span class='hs-conid'>ATyVar</span> <span class='hs-varid'>name</span> <span class='hs-varid'>tv</span><span class='hs-layout'>)</span>
<a name="line-102"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcTyVar</span> <span class='hs-varid'>tv</span>
<a name="line-103"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>tidy_ty</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenType</span> <span class='hs-varid'>tidy_env</span> <span class='hs-varid'>ty</span>
<a name="line-104"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>if</span> <span class='hs-varid'>ignore_it</span> <span class='hs-varid'>tidy_ty</span> <span class='hs-keyword'>then</span>
<a name="line-105"></a>	    <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-106"></a>         <span class='hs-keyword'>else</span> <span class='hs-keyword'>do</span>
<a name="line-107"></a>       <span class='hs-layout'>{</span> <span class='hs-keyword'>let</span> <span class='hs-comment'>-- The name tv is scoped, so we don't need to tidy it</span>
<a name="line-108"></a>            <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Scoped type variable"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>eq_stuff</span>
<a name="line-109"></a>                      <span class='hs-layout'>,</span> <span class='hs-varid'>nest</span> <span class='hs-num'>2</span> <span class='hs-varid'>bound_at</span><span class='hs-keyglyph'>]</span>
<a name="line-110"></a>
<a name="line-111"></a>            <span class='hs-varid'>eq_stuff</span> <span class='hs-keyglyph'>|</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcGetTyVar_maybe</span> <span class='hs-varid'>tidy_ty</span>
<a name="line-112"></a>		     <span class='hs-layout'>,</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>name</span> <span class='hs-varop'>==</span> <span class='hs-varid'>getOccName</span> <span class='hs-varid'>tv'</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>empty</span>
<a name="line-113"></a>		     <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>equals</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>tidy_ty</span>
<a name="line-114"></a>		<span class='hs-comment'>-- It's ok to use Type.getTyVar_maybe because ty is zonked by now</span>
<a name="line-115"></a>	    <span class='hs-varid'>bound_at</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>parens</span> <span class='hs-varop'>$</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"bound at:"</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>ppr</span> <span class='hs-layout'>(</span><span class='hs-varid'>getSrcLoc</span> <span class='hs-varid'>name</span><span class='hs-layout'>)</span>
<a name="line-116"></a> 
<a name="line-117"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env1</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span> <span class='hs-layout'>}</span>
<a name="line-118"></a>
<a name="line-119"></a><span class='hs-definition'>find_thing</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprPanic</span> <span class='hs-str'>"find_thing"</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>thing</span><span class='hs-layout'>)</span>
<a name="line-120"></a>
<a name="line-121"></a><a name="warnDefaulting"></a><span class='hs-definition'>warnDefaulting</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>Type</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-conid'>()</span>
<a name="line-122"></a><span class='hs-definition'>warnDefaulting</span> <span class='hs-varid'>wanteds</span> <span class='hs-varid'>default_ty</span>
<a name="line-123"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>warn_default</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>woptM</span> <span class='hs-conid'>Opt_WarnTypeDefaults</span>
<a name="line-124"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>env0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInitTidyEnv</span>
<a name="line-125"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>wanted_bag</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>listToBag</span> <span class='hs-varid'>wanteds</span>
<a name="line-126"></a>             <span class='hs-varid'>tidy_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyFreeTyVars</span> <span class='hs-varid'>env0</span> <span class='hs-varop'>$</span>
<a name="line-127"></a>                        <span class='hs-varid'>tyVarsOfCts</span> <span class='hs-varid'>wanted_bag</span>
<a name="line-128"></a>             <span class='hs-varid'>tidy_wanteds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapBag</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCt</span> <span class='hs-varid'>tidy_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>wanted_bag</span>
<a name="line-129"></a>             <span class='hs-layout'>(</span><span class='hs-varid'>loc</span><span class='hs-layout'>,</span> <span class='hs-varid'>ppr_wanteds</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>pprWithArising</span> <span class='hs-layout'>(</span><span class='hs-varid'>bagToList</span> <span class='hs-varid'>tidy_wanteds</span><span class='hs-layout'>)</span>
<a name="line-130"></a>             <span class='hs-varid'>warn_msg</span>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>hang</span> <span class='hs-layout'>(</span><span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Defaulting the following constraint(s) to type"</span><span class='hs-layout'>)</span>
<a name="line-131"></a>                                <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>quotes</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varid'>default_ty</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-132"></a>                            <span class='hs-num'>2</span> <span class='hs-varid'>ppr_wanteds</span>
<a name="line-133"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>setCtLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varop'>$</span> <span class='hs-varid'>warnTc</span> <span class='hs-varid'>warn_default</span> <span class='hs-varid'>warn_msg</span> <span class='hs-layout'>}</span>
</pre>\end{code}

Note [Runtime skolems]
~~~~~~~~~~~~~~~~~~~~~~
We want to give a reasonably helpful error message for ambiguity
arising from *runtime* skolems in the debugger.  These
are created by in RtClosureInspect.zonkRTTIType.  

%************************************************************************
%*									*
                 Error from the canonicaliser
	 These ones are called *during* constraint simplification
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="solverDepthErrorTcS"></a><span class='hs-definition'>solverDepthErrorTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Ct</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2"></a><span class='hs-definition'>solverDepthErrorTcS</span> <span class='hs-varid'>depth</span> <span class='hs-varid'>stack</span>
<a name="line-3"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>null</span> <span class='hs-varid'>stack</span>	    <span class='hs-comment'>-- Shouldn't happen unless you say -fcontext-stack=0</span>
<a name="line-4"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>failWith</span> <span class='hs-varid'>msg</span>
<a name="line-5"></a>  <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span>
<a name="line-6"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setCtFlavorLoc</span> <span class='hs-layout'>(</span><span class='hs-varid'>cc_ev</span> <span class='hs-varid'>top_item</span><span class='hs-layout'>)</span> <span class='hs-varop'>$</span>
<a name="line-7"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>zstack</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-varid'>zonkCt</span> <span class='hs-varid'>stack</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>env0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInitTidyEnv</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>zstack_tvs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>foldr</span> <span class='hs-layout'>(</span><span class='hs-varid'>unionVarSet</span> <span class='hs-varop'>.</span> <span class='hs-varid'>tyVarsOfCt</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyVarSet</span> <span class='hs-varid'>zstack</span>
<a name="line-10"></a>             <span class='hs-varid'>tidy_env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyFreeTyVars</span> <span class='hs-varid'>env0</span> <span class='hs-varid'>zstack_tvs</span>
<a name="line-11"></a>             <span class='hs-varid'>tidy_cts</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyCt</span> <span class='hs-varid'>tidy_env</span><span class='hs-layout'>)</span> <span class='hs-varid'>zstack</span>
<a name="line-12"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>failWithTcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidy_env</span><span class='hs-layout'>,</span> <span class='hs-varid'>hang</span> <span class='hs-varid'>msg</span> <span class='hs-num'>2</span> <span class='hs-layout'>(</span><span class='hs-varid'>vcat</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>ppr</span> <span class='hs-varop'>.</span> <span class='hs-varid'>ctPred</span><span class='hs-layout'>)</span> <span class='hs-varid'>tidy_cts</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-13"></a>  <span class='hs-keyword'>where</span>
<a name="line-14"></a>    <span class='hs-varid'>top_item</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>head</span> <span class='hs-varid'>stack</span>
<a name="line-15"></a>    <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>vcat</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Context reduction stack overflow; size ="</span><span class='hs-layout'>)</span> <span class='hs-varop'>&lt;+&gt;</span> <span class='hs-varid'>int</span> <span class='hs-varid'>depth</span>
<a name="line-16"></a>               <span class='hs-layout'>,</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Use -fcontext-stack=N to increase stack size to N"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>]</span>
<a name="line-17"></a>
<a name="line-18"></a><span class='hs-comment'>{- DV: Changing this because Derived's no longer have ids ... Kind of a corner case ...
<a name="line-19"></a>  = setCtFlavorLoc (cc_ev top_item) $
<a name="line-20"></a>    do { ev_vars &lt;- mapM (zonkEvVar . cc_id) stack
<a name="line-21"></a>       ; env0 &lt;- tcInitTidyEnv
<a name="line-22"></a>       ; let tidy_env = tidyFreeTyVars env0 (tyVarsOfEvVars ev_vars)
<a name="line-23"></a>             tidy_ev_vars = map (tidyEvVar tidy_env) ev_vars
<a name="line-24"></a>       ; failWithTcM (tidy_env, hang msg 2 (pprEvVars tidy_ev_vars)) }
<a name="line-25"></a>  where
<a name="line-26"></a>    top_item = head stack
<a name="line-27"></a>    msg = vcat [ ptext (sLit "Context reduction stack overflow; size =") &lt;+&gt; int depth
<a name="line-28"></a>               , ptext (sLit "Use -fcontext-stack=N to increase stack size to N") ]
<a name="line-29"></a>-}</span>
<a name="line-30"></a>
<a name="line-31"></a>
<a name="line-32"></a><a name="flattenForAllErrorTcS"></a><span class='hs-definition'>flattenForAllErrorTcS</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-33"></a><span class='hs-definition'>flattenForAllErrorTcS</span> <span class='hs-varid'>fl</span> <span class='hs-varid'>ty</span>
<a name="line-34"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setCtFlavorLoc</span> <span class='hs-varid'>fl</span> <span class='hs-varop'>$</span> 
<a name="line-35"></a>    <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>env0</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>tcInitTidyEnv</span>
<a name="line-36"></a>       <span class='hs-layout'>;</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>tidyOpenType</span> <span class='hs-varid'>env0</span> <span class='hs-varid'>ty</span> 
<a name="line-37"></a>             <span class='hs-varid'>msg</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sep</span> <span class='hs-keyglyph'>[</span> <span class='hs-varid'>ptext</span> <span class='hs-layout'>(</span><span class='hs-varid'>sLit</span> <span class='hs-str'>"Cannot deal with a type function under a forall type:"</span><span class='hs-layout'>)</span>
<a name="line-38"></a>                       <span class='hs-layout'>,</span> <span class='hs-varid'>ppr</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>]</span>
<a name="line-39"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>failWithTcM</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span> <span class='hs-varid'>msg</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
</pre>\end{code}

%************************************************************************
%*									*
                 Setting the context
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="setCtFlavorLoc"></a><span class='hs-definition'>setCtFlavorLoc</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>CtEvidence</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-varid'>a</span>
<a name="line-2"></a><span class='hs-definition'>setCtFlavorLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Wanted</span>  <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_wloc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setCtLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>thing</span>
<a name="line-3"></a><span class='hs-definition'>setCtFlavorLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Derived</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_wloc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setCtLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>thing</span>
<a name="line-4"></a><span class='hs-definition'>setCtFlavorLoc</span> <span class='hs-layout'>(</span><span class='hs-conid'>Given</span>   <span class='hs-layout'>{</span> <span class='hs-varid'>ctev_gloc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>loc</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span> <span class='hs-varid'>thing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>setCtLoc</span> <span class='hs-varid'>loc</span> <span class='hs-varid'>thing</span>
</pre>\end{code}

%************************************************************************
%*									*
                 Tidying
%*									*
%************************************************************************

\begin{code}
<pre><a name="line-1"></a><a name="zonkTidyTcType"></a><span class='hs-definition'>zonkTidyTcType</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>TidyEnv</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcType</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>TidyEnv</span><span class='hs-layout'>,</span> <span class='hs-conid'>TcType</span><span class='hs-layout'>)</span>
<a name="line-2"></a><span class='hs-definition'>zonkTidyTcType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-varid'>ty'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTcType</span> <span class='hs-varid'>ty</span>
<a name="line-3"></a>                           <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>tidyOpenType</span> <span class='hs-varid'>env</span> <span class='hs-varid'>ty'</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-4"></a>
<a name="line-5"></a><a name="zonkTidyOrigin"></a><span class='hs-definition'>zonkTidyOrigin</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>ReportErrCtxt</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>CtOrigin</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>TcM</span> <span class='hs-layout'>(</span><span class='hs-conid'>ReportErrCtxt</span><span class='hs-layout'>,</span> <span class='hs-conid'>CtOrigin</span><span class='hs-layout'>)</span>
<a name="line-6"></a><span class='hs-definition'>zonkTidyOrigin</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>(</span><span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnifyOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act</span><span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-7"></a>  <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-layout'>{</span> <span class='hs-layout'>(</span><span class='hs-varid'>env1</span><span class='hs-layout'>,</span>  <span class='hs-varid'>act'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-layout'>(</span><span class='hs-varid'>cec_tidy</span> <span class='hs-varid'>ctxt</span><span class='hs-layout'>)</span> <span class='hs-varid'>act</span>
<a name="line-8"></a>       <span class='hs-layout'>;</span> <span class='hs-layout'>(</span><span class='hs-varid'>env2</span><span class='hs-layout'>,</span> <span class='hs-varid'>exp'</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>zonkTidyTcType</span> <span class='hs-varid'>env1</span>            <span class='hs-varid'>exp</span>
<a name="line-9"></a>       <span class='hs-layout'>;</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span> <span class='hs-varid'>ctxt</span> <span class='hs-layout'>{</span> <span class='hs-varid'>cec_tidy</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>env2</span> <span class='hs-layout'>}</span>
<a name="line-10"></a>                <span class='hs-layout'>,</span> <span class='hs-conid'>TypeEqOrigin</span> <span class='hs-layout'>(</span><span class='hs-conid'>UnifyOrigin</span> <span class='hs-layout'>{</span> <span class='hs-varid'>uo_actual</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>act'</span><span class='hs-layout'>,</span> <span class='hs-varid'>uo_expected</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>exp'</span> <span class='hs-layout'>}</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>}</span>
<a name="line-11"></a><span class='hs-definition'>zonkTidyOrigin</span> <span class='hs-varid'>ctxt</span> <span class='hs-varid'>orig</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>ctxt</span><span class='hs-layout'>,</span> <span class='hs-varid'>orig</span><span class='hs-layout'>)</span>
</pre>\end{code}
</body>
</html>
